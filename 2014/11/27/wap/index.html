<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> wap2.0php代码审计学习 · xd_xd's blog</title><meta name="description" content="wap2.0php代码审计学习 - xd_xd"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><script src="/js/jquery-3.1.0.min.js"></script><script src="/js/jquery.goup.js"></script><script src="/js/goup.js"></script><link rel="search" type="application/opensearchdescription+xml" href="http://xdxd.love/atom.xml" title="xd_xd's blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/logo.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="https://github.com/stayliv3" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/archives" target="_self" class="nav-list-link">ARCHIVES</a></li><li class="nav-list-item"><a href="/friends" target="_self" class="nav-list-link">FRIENDS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">wap2.0php代码审计学习</h1><div class="post-info">Nov 27, 2014</div><div class="post-content"><h2 id="wap2-0安装">wap2.0安装</h2><p>下载地址<a href="http://sourceforge.net/projects/awap/files/wap-2.0/，有3种不同操作系统平台的程序包。由于在windows环境下测试的时候发现有些bug。所以这里的测试环境采用了ubuntu+wap-2.0.x86.tar.gz。" target="_blank" rel="external">http://sourceforge.net/projects/awap/files/wap-2.0/，有3种不同操作系统平台的程序包。由于在windows环境下测试的时候发现有些bug。所以这里的测试环境采用了ubuntu+wap-2.0.x86.tar.gz。</a></p>
<pre><code>下载解压：<span class="tag">tar</span> <span class="tag">zxvf</span> <span class="tag">wap-2</span><span class="class">.0</span><span class="class">.x86</span><span class="class">.tar</span><span class="class">.gz</span>
</code></pre><h2 id="使用手册">使用手册</h2><p>在线手册<a href="http://awap.sourceforge.net/support.html" target="_blank" rel="external">http://awap.sourceforge.net/support.html</a> 或者进入wap目录。输入：java -jar wap.jar -h 也会打印帮助文档。</p>
<p><img src="/images/wap1.jpg" alt="11"></p>
<p>如果我们想要对一个cms系统进行漏洞挖掘，使用-p参数指定应用的路径就可以了。比如：</p>
<pre><code>java -jar wap<span class="class">.jar</span>  -<span class="tag">a</span> -sqli -xss -ci -<span class="tag">p</span> ~/下载/cmseasy5.<span class="number">5</span>/uploads/
</code></pre><p>-a选项是只检查漏洞不自动修复漏洞，因为wap2.0有自动修复漏洞功能。-sqli -xss -ci 就是检测这三种类型的漏洞。-p 指定cms的目录。</p>
<h2 id="相关资料">相关资料</h2><p>该工具在互联网找到的资料只有其官网的信息<a href="http://awap.sourceforge.net/support.html" target="_blank" rel="external">http://awap.sourceforge.net/support.html</a> 这里提供了关于该工具的3篇论文。下面是论文中wap的架构，可以大致了解wap的特点和应用场景。</p>
<p><img src="/images/wap2.jpg" alt="11"></p>
<p>WAP可以基于语义分析应用的源代码，并对数据流进行分析，比如它会追踪$_GET, $_POST等入口点，并且追踪确认是否最终有敏感的方法可被执行。在探测结束后，这个工具还会通过数据挖掘确认漏洞是否真的存在或误报。它还有个自动修正代码中缺陷的功能。</p>
<p>这是wap对一些开源软件扫描的结果，可以看到474个报告中，只有15个误报，其他都是真实存在的漏洞。这个准确度还是相当高的。当然他的缺陷也就很明显了，减少了误报，也极大的增加了漏报。它只能发现一些典型的漏洞。在之后的实际测试中也基本证实了这一点。<br><img src="/images/wap3.jpg" alt="11"></p>
<h2 id="实例测试及感受">实例测试及感受</h2><p>在实际测试的过程中发现wap经常会出现异常退出或者长时间无法完成扫描的情况。wap的优点是误报少，缺点就是只适合发现典型的漏洞，对大量源代码进行扫描或者没有做过审计的代码进行扫描应该会有一些收获。但是对相对成熟一些的程序，难以发现有效的漏洞。下面使用wap对piwigo相册程序进行扫描时发现的一个报告：</p>
<pre><code>&gt; &gt; &gt; &gt;  File: /home/litdg/下载/piwigo/admin/theme.php &lt; &lt; &lt; &lt;
     &gt; Information:
        - Number <span class="keyword">of</span> Lines <span class="keyword">of</span> Code: <span class="number">53</span>
        - Is a include file: no
        - Included files: none
        - Defined user function: none
        - Number <span class="keyword">of</span> Vulnerabilities detected: <span class="number">1</span>
           - Real Vulnerabilities: <span class="number">1</span>
           - False positives: <span class="number">0</span>

    = = = =  Vulnerability n.: <span class="number">1</span>  = = = =
    Type: RFI, LFI, DT

    Vulnerable code:
    <span class="number">44</span>: <span class="variable">$filename</span> = PHPWG_THEMES_PATH.$_GET[<span class="string">'theme'</span>].<span class="string">'/admin/admin.inc.php'</span>;
    <span class="number">47</span>:   include_once(<span class="variable">$filename</span>);

    Corrected code:
    <span class="number">44</span>: <span class="variable">$filename</span> = PHPWG_THEMES_PATH.$_GET[<span class="string">'theme'</span>].<span class="string">'/admin/admin.inc.php'</span>;
    <span class="number">47</span>: <span class="keyword">if</span> (san_mix($_GET[<span class="string">'theme'</span>], <span class="string">'include'</span>, null) == <span class="number">0</span>)
    <span class="number">48</span>:      include_once(<span class="variable">$filename</span>);
</code></pre><p>查看源代码发现，这里确实是一个典型的文件包含的的写法。但是代码在前面有一个白名单判断的条件，是不存在漏洞的。</p>
<p><img src="/images/wap4.jpg" alt="11"></p>
</div></article></div></section><footer><div class="paginator"><a href="/2014/12/01/burp/" class="prev">上一篇</a><a href="/2014/11/25/discuz/" class="next">下一篇</a></div><div class="copyright"><p>© 2016 <a href="http://xdxd.love">xd_xd</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/hkalexling/Yuno-Apollo" target="_blank">Yuno-Apollo</a>.</p></div></footer></div><script src="https://cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>