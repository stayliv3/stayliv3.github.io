<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> discuz X 任意文件删除漏洞学习 · xd_xd's blog</title><meta name="description" content="discuz X 任意文件删除漏洞学习 - xd_xd"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://xdxd.love/atom.xml" title="xd_xd's blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/u/5256150165?is_all=1" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/stayliv3" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">discuz X 任意文件删除漏洞学习</h1><div class="post-info">Nov 25, 2014</div><div class="post-content"><p>##测试方式<br>漏洞来源：<a href="http://www.wooyun.org/bugs/wooyun-2010-065513" target="_blank" rel="external">http://www.wooyun.org/bugs/wooyun-2010-065513</a><br>先说一下这个漏洞的利用过程吧。这个原帖里已经写的比较清楚了。注册用户。<br>1，访问：<a href="http://localhost/Discuz_X3.1_SC_UTF8/upload/home.php?mod=spacecp&amp;ac=profile&amp;op=base" target="_blank" rel="external">http://localhost/Discuz_X3.1_SC_UTF8/upload/home.php?mod=spacecp&amp;ac=profile&amp;op=base</a><br><img src="/images/discuz1.jpg" alt="1"></p>
<p>2，修改一个资料字段为要删除的目标地址。这里使用birthprovince字段。记录下formhash，备用。<br><img src="/images/discuz2.jpg" alt="1"></p>
<p>3，post profilesubmit=1&amp;formhash=c9121ba1(自己的formhash)到<a href="http://localhost/Discuz_X3.1_SC_GBK/upload/home.php?mod=spacecp&amp;ac=profile&amp;op=base&amp;deletefile[birthprovince]=aaa" target="_blank" rel="external">http://localhost/Discuz_X3.1_SC_GBK/upload/home.php?mod=spacecp&amp;ac=profile&amp;op=base&amp;deletefile[birthprovince]=aaa</a> 就可以了。</p>
<p> <img src="/images/discuz3.jpg" alt="1"></p>
<p>##代码分析</p>
<p>分析版本discuzX3.1最新版 缺陷代码:/upload/source/include/spacecp/spacecp_profile.php</p>
<pre><code><span class="keyword">if</span>($_GET[<span class="string">'deletefile'</span>] &amp;&amp; is_array($_GET[<span class="string">'deletefile'</span>])) {
        foreach($_GET[<span class="string">'deletefile'</span>] as <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) {
            if(isset($_G[<span class="string">'cache'</span>][<span class="string">'profilesetting'</span>][<span class="variable">$key</span>])) {
                @unlink(getglobal(<span class="string">'setting/attachdir'</span>).<span class="string">'./profile/'</span>.<span class="variable">$space</span>[<span class="variable">$key</span>]);
                @unlink(getglobal(<span class="string">'setting/attachdir'</span>).<span class="string">'./profile/'</span>.<span class="variable">$verifyinfo</span>[<span class="string">'field'</span>][<span class="variable">$key</span>]);
                <span class="variable">$verifyarr</span>[<span class="variable">$key</span>] = <span class="variable">$setarr</span>[<span class="variable">$key</span>] = <span class="string">''</span>;
            }
        }
    }
</code></pre><p>$space[$key]和$verifyinfo[‘field’][$key]的来源。变量进入了unlink函数。寻找$space[$key]和$verifyinfo[‘field’][$key]的来源。</p>
<p>定位到23行：</p>
<pre><code><span class="variable">$space</span> = getuserbyuid函数。($_G[<span class="string">'uid'</span>]);
space_merge(<span class="variable">$space</span>, <span class="string">'field_home'</span>);
space_merge(<span class="variable">$space</span>, <span class="string">'profile'</span>);
</code></pre><p>$_G[‘uid’]是用户的ID，跟踪getuserbyuid函数。/upload/source/function/function_core.php 76行：</p>
<pre><code><span class="keyword">function</span> getuserbyuid(<span class="variable">$uid</span>, <span class="variable">$fetch</span>_archive = <span class="number">0</span>) {
    static <span class="variable">$users</span> = array();
    if(empty(<span class="variable">$users</span>[<span class="variable">$uid</span>])) {
        <span class="variable">$users</span>[<span class="variable">$uid</span>] = C::t(<span class="string">'common_member'</span>.(<span class="variable">$fetch</span>_archive === <span class="number">2</span> ? <span class="string">'_archive'</span> : <span class="string">''</span>))-&gt;fetch(<span class="variable">$uid</span>);
        if(<span class="variable">$fetch</span>_archive === <span class="number">1</span> &amp;&amp; empty(<span class="variable">$users</span>[<span class="variable">$uid</span>])) {
            <span class="variable">$users</span>[<span class="variable">$uid</span>] = C::t(<span class="string">'common_member_archive'</span>)-&gt;fetch(<span class="variable">$uid</span>);
        }
    }
    if(!isset(<span class="variable">$users</span>[<span class="variable">$uid</span>][<span class="string">'self'</span>]) &amp;&amp; <span class="variable">$uid</span> == getglobal(<span class="string">'uid'</span>) &amp;&amp; getglobal(<span class="string">'uid'</span>)) {
        <span class="variable">$users</span>[<span class="variable">$uid</span>][<span class="string">'self'</span>] = <span class="number">1</span>;
    }
    return <span class="variable">$users</span>[<span class="variable">$uid</span>];
}
</code></pre><p>getuserbyuid查询的pre_common_member表的数据。</p>
<pre><code>space_merge(<span class="variable">$space</span>, <span class="string">'field_home'</span>);
space_merge(<span class="variable">$space</span>, <span class="string">'profile'</span>);
</code></pre><p>是把pre_common_member_field_home和pre_common_member_profile表合并到$space中。所以$space一共92个成员，最后。</p>
<pre><code><span class="variable">$space</span> = getuserbyuid函数。($_G[<span class="string">'uid'</span>]);  (<span class="number">24</span>个字段)
space_merge(<span class="variable">$space</span>, <span class="string">'field_home'</span>); (<span class="number">18</span>个字段)
space_merge(<span class="variable">$space</span>, <span class="string">'profile'</span>); (<span class="number">52</span>个字段)  都有uid字段合并。
</code></pre><p>分析完$space就发现，这三个表有太多可以控制的变量了。接下来分析删除文件的流程，有个判断条件：</p>
<pre><code>if(isset($_G[<span class="link_label">'cache'</span>][<span class="link_reference">'profilesetting'</span>][<span class="link_label">$key</span>])) 这个条件为真才行。
</code></pre><p>在文件/upload/source/function/function_profile.php 中</p>
<pre><code>if(empty($_G[<span class="link_label">'cache'</span>][<span class="link_reference">'profilesetting'</span>])) {
<span class="code">    loadcache('profilesetting');</span>
}
</code></pre><p>跟踪loadcache函数：</p>
<pre><code><span class="keyword">function</span> loadcache(<span class="variable">$cachenames</span>, <span class="variable">$force</span> = <span class="literal">false</span>) {
    global $_G;
    static <span class="variable">$loadedcache</span> = array();
    <span class="variable">$cachenames</span> = is_array(<span class="variable">$cachenames</span>) ? <span class="variable">$cachenames</span> : array(<span class="variable">$cachenames</span>);
    <span class="variable">$caches</span> = array();
    foreach (<span class="variable">$cachenames</span> as <span class="variable">$k</span>) {
        if(!isset(<span class="variable">$loadedcache</span>[<span class="variable">$k</span>]) || <span class="variable">$force</span>) {
            <span class="variable">$caches</span>[] = <span class="variable">$k</span>;
            <span class="variable">$loadedcache</span>[<span class="variable">$k</span>] = true;
        }
    }

    if(!empty(<span class="variable">$caches</span>)) {
        <span class="variable">$cachedata</span> = C::t(<span class="string">'common_syscache'</span>)-&gt;fetch_all(<span class="variable">$caches</span>);
        foreach(<span class="variable">$cachedata</span> as <span class="variable">$cname</span> =&gt; <span class="variable">$data</span>) {
            if(<span class="variable">$cname</span> == <span class="string">'setting'</span>) {
                $_G[<span class="string">'setting'</span>] = <span class="variable">$data</span>;
            } elseif(<span class="variable">$cname</span> == <span class="string">'usergroup_'</span>.$_G[<span class="string">'groupid'</span>]) {
                $_G[<span class="string">'cache'</span>][<span class="variable">$cname</span>] = $_G[<span class="string">'group'</span>] = <span class="variable">$data</span>;
            } elseif(<span class="variable">$cname</span> == <span class="string">'style_default'</span>) {
                $_G[<span class="string">'cache'</span>][<span class="variable">$cname</span>] = $_G[<span class="string">'style'</span>] = <span class="variable">$data</span>;
            } elseif(<span class="variable">$cname</span> == <span class="string">'grouplevels'</span>) {
                $_G[<span class="string">'grouplevels'</span>] = <span class="variable">$data</span>;
            } else {
                $_G[<span class="string">'cache'</span>][<span class="variable">$cname</span>] = <span class="variable">$data</span>;
            }
        }
    }
    return true;
}
</code></pre><p>发现$_G[‘cache’][‘profilesetting’]来自于common_syscache表。查询数据库中该表字段内容如下：</p>
<p> <img src="/images/discuz4.jpg" alt="1"></p>
<p>经过灰盒测试发现，$_G[‘cache’][‘profilesetting’]一共有37个成员。是一部分pre_common_member_profile表的字段。所以，这里利用的话只能利用common_member_profile表中的可控字段。</p>
<p>##修复方案</p>
<p>截止到目前X3.1没有发布补丁，X3.2在原安装包上进行了修复，也没有发布单独的补丁。所以在2014-06-20甚至更后一段时间之前安装的discuz程序都存在这个漏洞。而由于官方没有发布补丁，所以相当一部分包括大型互联网公司的论坛都没有修复这个漏洞。只是这个漏洞的利用方式删除文件，获取shell的方式可以通过删除安装锁定文件重装拿shell。只是这样子的方式过于粗暴，如果有更优雅的二次利用可以获取shell的话，这个漏洞肯定会引起更多的关注。<br>X3.2的修复之后为：</p>
<pre><code><span class="keyword">if</span>($_GET[<span class="string">'deletefile'</span>] &amp;&amp; is_array($_GET[<span class="string">'deletefile'</span>])) {
    foreach($_GET[<span class="string">'deletefile'</span>] as <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) {
    //var_dump($_G[<span class="string">'cache'</span>][<span class="string">'profilesetting'</span>]);
        if(isset($_G[<span class="string">'cache'</span>][<span class="string">'profilesetting'</span>][<span class="variable">$key</span>]) &amp;&amp; $_G[<span class="string">'cache'</span>][<span class="string">'profilesetting'</span>][<span class="variable">$key</span>][<span class="string">'formtype'</span>] == <span class="string">'file'</span>) {
            @unlink(getglobal(<span class="string">'setting/attachdir'</span>).<span class="string">'./profile/'</span>.<span class="variable">$space</span>[<span class="variable">$key</span>]);
            //echo <span class="string">'11111111'</span>;
            @unlink(getglobal(<span class="string">'setting/attachdir'</span>).<span class="string">'./profile/'</span>.<span class="variable">$verifyinfo</span>[<span class="string">'field'</span>][<span class="variable">$key</span>]);
            <span class="variable">$verifyarr</span>[<span class="variable">$key</span>] = <span class="variable">$setarr</span>[<span class="variable">$key</span>] = <span class="string">''</span>;
</code></pre><p>加了一个判断 $_G[‘cache’][‘profilesetting’][$key][‘formtype’] == ‘file’ 为true。前面分析的时候提到过，$_G[‘cache’][‘profilesetting’]来自于pre_common_member_profile表，而每个字段的formtype在pre_common_member_profile_setting表中记录：</p>
<p> <img src="/images/discuz5.jpg" alt="1"></p>
<p>没有任何一个字段的type是file。所以这里这语句应该是永远都到达不了的。也就没有办法绕过了。所以修复的话可以考虑加这个判断，甚至直接注释掉相关代码代码。如果分析有错误，欢迎指正。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2014/11/27/wap/" class="prev">上一篇</a><a href="/2014/11/17/strcmp/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2016 <a href="http://xdxd.love">xd_xd</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>