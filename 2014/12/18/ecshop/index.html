<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> ecshop patch15分析 · xd_xd's blog</title><meta name="description" content="ecshop patch15分析 - xd_xd"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><script src="/js/jquery-3.1.0.min.js"></script><script src="/js/jquery.goup.js"></script><script src="/js/goup.js"></script><link rel="search" type="application/opensearchdescription+xml" href="http://xdxd.love/atom.xml" title="xd_xd's blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/logo.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="https://github.com/stayliv3" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/archives" target="_self" class="nav-list-link">ARCHIVES</a></li><li class="nav-list-item"><a href="/friends" target="_self" class="nav-list-link">FRIENDS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">ecshop patch15分析</h1><div class="post-info">Dec 18, 2014</div><div class="post-content"><p>之前乌云有个ecshop的漏洞关注度比较高，<a href="http://www.wooyun.org/bugs/wooyun-2014-086052，出补丁了就看了下。当然结论就是没发现啥有价值的东西。下面是一个简要的分析过程。" target="_blank" rel="external">http://www.wooyun.org/bugs/wooyun-2014-086052，出补丁了就看了下。当然结论就是没发现啥有价值的东西。下面是一个简要的分析过程。</a></p>
<p>看官方的说明，没看到有修复高危的SQL注入。</p>
<p><img src="/images/ecshop1.jpg" alt="img"></p>
<p>先下载好patch15.rar之前一个patch是14。进行一下对比。</p>
<p><img src="/images/ecshop2.jpg" alt="img"></p>
<p>这个地方的修复比较明显，应该是说明里的后天添加管理员SQL注入。is_only函数如下，</p>
<pre><code> */
<span class="keyword">function</span> is_only(<span class="variable">$col</span>, <span class="variable">$name</span>, <span class="variable">$id</span> = <span class="number">0</span>, <span class="variable">$where</span>=<span class="string">''</span>)
{
    <span class="variable">$sql</span> = <span class="string">'SELECT COUNT(*) FROM '</span> .<span class="variable">$this-</span>&gt;table. <span class="string">" WHERE $col = '$name'"</span>;
    <span class="variable">$sql</span> .= empty(<span class="variable">$id</span>) ? <span class="string">''</span> : <span class="string">' AND '</span> . <span class="variable">$this-</span>&gt;id . <span class="string">" &lt;&gt; '$id'"</span>;
    <span class="variable">$sql</span> .= empty(<span class="variable">$where</span>) ? <span class="string">''</span> : <span class="string">' AND '</span> .<span class="variable">$where</span>;

    return (<span class="variable">$this-</span>&gt;db-&gt;getOne(<span class="variable">$sql</span>) == <span class="number">0</span>);
}
</code></pre><p>stripslashes函数导致单引号出现，存在SQL注入。ecshop的后台安全性其实不高。稍微搜索了一下，就发现了另外一处同样原因导致的SQL注入。往后面看几行，这个添加管理员的功能，还验证了一下email字段。这里同样使用了stripslashes。所以官方的这个修复仅仅是说哪补哪。不够用心啊。</p>
<p><img src="/images/ecshop3.jpg" alt="img"></p>
<p><img src="/images/ecshop4.jpg" alt="img"></p>
<p>lib_main.php里的修复是加了htmlspecialchars转码，这段代码的功能是统计来源，之前好像爆过SQL注入，所以添加了addslash转义。这里就应该是公告里说的流量统计代码xss攻击。根据文件对比就只发现了这两处修补的地方。<br><img src="/images/ecshop5.jpg" alt="img"></p>
</div></article></div></section><footer><div class="paginator"><a href="/2015/01/14/piwigo/" class="prev">上一篇</a><a href="/2014/12/05/ipbsql/" class="next">下一篇</a></div><div class="copyright"><p>© 2016 <a href="http://xdxd.love">xd_xd</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/hkalexling/Yuno-Apollo" target="_blank">Yuno-Apollo</a>.</p></div></footer></div><script src="https://cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>