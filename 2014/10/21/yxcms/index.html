<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> yxcms1.2.6任意文件删除漏洞分析 · xd_xd's blog</title><meta name="description" content="yxcms1.2.6任意文件删除漏洞分析 - xd_xd"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><script src="/js/jquery-3.1.0.min.js"></script><script src="/js/jquery.goup.js"></script><script src="/js/goup.js"></script><link rel="search" type="application/opensearchdescription+xml" href="http://xdxd.love/atom.xml" title="xd_xd's blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/logo.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="https://github.com/hkalexling" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/archives" target="_self" class="nav-list-link">ARCHIVES</a></li><li class="nav-list-item"><a href="/friends" target="_self" class="nav-list-link">FRIENDS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">yxcms1.2.6任意文件删除漏洞分析</h1><div class="post-info">Oct 21, 2014</div><div class="post-content"><p>测试版本:1.2.6</p>
<p>YXcms的在使用unlink函数删除文件的时候没有考虑到对该参数做一个限制，导致存在很多个任意文件删除的漏洞。漏洞代码也比较直接，比如：</p>
<pre><code><span class="keyword">if</span>(!<span class="keyword">empty</span>($_POST[<span class="string">'oldheadpic'</span>])){
    <span class="variable">$picpath</span>=<span class="variable">$this-</span>&gt;uploadpath.$_POST[<span class="string">'oldheadpic'</span>];
    if(file_exists(<span class="variable">$picpath</span>)) @unlink(<span class="variable">$picpath</span>);
</code></pre><p>这里是更新头像之后删除旧的头像图片。而旧头像的路径是直接从客户端发送的参数，接受之后仅仅判断了一下文件是否存在，如果存在就删除。从而存在漏洞。</p>
<p>任意文件删除的漏洞有好几个点都存在，官方也进行了一些修复。先看一下官方修复的方式，这里是乌云报过的漏洞。<a href="http://wooyun.org/bugs/wooyun-2010-047226" target="_blank" rel="external">http://wooyun.org/bugs/wooyun-2010-047226</a> 修复前存在问题的代码：</p>
<pre><code><span class="keyword">if</span>(!<span class="keyword">empty</span>($_POST[<span class="string">'oldpicture'</span>]) &amp;&amp; $_POST[<span class="string">'oldpicture'</span>]!=<span class="variable">$this-</span>&gt;nopic){

    <span class="variable">$picpath</span>=<span class="variable">$this-</span>&gt;uploadpath.$_POST[<span class="string">'oldpicture'</span>];

    echo <span class="variable">$picpath</span>;

    if(file_exists(<span class="variable">$picpath</span>)) @unlink(<span class="variable">$picpath</span>);//删除文艺文件
</code></pre><p>修复之后的代码：</p>
<pre><code><span class="keyword">if</span>(!<span class="keyword">empty</span>($_POST[<span class="string">'oldpicture'</span>]) &amp;&amp; $_POST[<span class="string">'oldpicture'</span>]!=<span class="variable">$this-</span>&gt;nopic){
        <span class="variable">$picpath</span>=<span class="variable">$this-</span>&gt;uploadpath.$_POST[<span class="string">'oldpicture'</span>];
        <span class="variable">$lasts</span>=strtolower(substr($_POST[<span class="string">'oldpicture'</span>],-<span class="number">3</span>));
        if(file_exists(<span class="variable">$picpath</span>) &amp;&amp; in_array(<span class="variable">$lasts</span>,array(<span class="string">'gif'</span>,<span class="string">'jpg'</span>,<span class="string">'png'</span>,<span class="string">'bmp'</span>))) @unlink(<span class="variable">$picpath</span>);
    }
</code></pre><p>这里加入了一个对传入的$_POST[‘oldpicture’]参数的判断，判断这个文件名后缀是否是gif，jpg等。这个修复方案显示是不完善的。之所以存在任意文件删除的问题根源在于传入的文件名$_POST[‘oldpicture’]完全可控，可以使用任意的”.. / \ “字符来遍历任意路径下的文件。所以防御的思路应该是从限制任意路径遍历入手，而不是限制文件类型。限制了文件类型最直接的问题就是可以这个漏洞退化成了一个删除任意图片文件。任何一个注册用户都可以将整个站点的所有图片文件删除。而在php5.3.4以前的版本中，可以使用\0(0x00字节)进行文件操作的截断。所以对布署在php5.3.4以前版本中的应用来说，任意文件删除的漏洞依然没有修复。</p>
<p>最后分析一个最新版中二次操作导致的任意文件删除漏洞。这个漏洞还没有人公开分析过。问题代码存在photoController.php。通过搜索unlink关键字定位到代码：</p>
<pre><code><span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$photos</span>[<span class="string">'photolist'</span>])){
    <span class="variable">$phoarr</span>=explode(<span class="string">','</span>,<span class="variable">$photos</span>[<span class="string">'photolist'</span>]);
    foreach (<span class="variable">$phoarr</span> as <span class="variable">$vo</span>){
        if(file_exists(<span class="variable">$path</span>.<span class="variable">$vo</span>))
        unlink(<span class="variable">$path</span>.<span class="variable">$vo</span>);
        if(file_exists(<span class="variable">$path</span>.<span class="string">'thumb_'</span>.<span class="variable">$vo</span>))
        @unlink(<span class="variable">$path</span>.<span class="string">'thumb_'</span>.<span class="variable">$vo</span>);
    }
</code></pre><p>删除使用的数据来源于$photos[‘photolist’]变量。315行，变量$photo来源于数据库中查询的结果</p>
<pre><code><span class="variable">$photos</span>=model(<span class="string">'photo'</span>)-&gt;find(<span class="string">"id='$id'"</span>,<span class="string">'photolist,sort,extfield,account'</span>);
</code></pre><p>经过分析，photo表里的数据在新建图集或者编辑图集的时候插入数据库的。数据来源于用户数据。相关代码该文件151行：</p>
<pre><code><span class="keyword">if</span>(!<span class="keyword">empty</span>($_POST[<span class="string">'photolist'</span>]))
<span class="variable">$data</span>[<span class="string">'photolist'</span>]=implode(<span class="string">','</span>,$_POST[<span class="string">'photolist'</span>]);
<span class="keyword">if</span>(!<span class="keyword">empty</span>($_POST[<span class="string">'conlist'</span>]))
<span class="variable">$data</span>[<span class="string">'conlist'</span>]=implode(<span class="string">','</span>,<span class="keyword">in</span>($_POST[<span class="string">'conlist'</span>]));
<span class="keyword">if</span>(model(<span class="string">'photo'</span>)-&gt;<span class="keyword">insert</span>(<span class="variable">$data</span>))
<span class="variable">$this-</span>&gt;success(<span class="string">'图集添加成功~'</span>,url(<span class="string">'photo/index'</span>));
<span class="keyword">else</span> <span class="variable">$this-</span>&gt;error(<span class="string">'图集添加失败'</span>);
</code></pre><p>从$_POST[‘photolist’]中取了数据，插入到了photo表中。所以添加图集的时候，修改post数据中photolist%5B%5D=../../protected/apps/install/install.lock 就可控制目标数据。</p>
<p><img src="/images/13204650360976da2b9e451f6d5366cfcf0e79aa.jpg" alt="data"></p>
<p>删除图集的时候就可以看到数据被带入unlink函数中，安装锁定文件被删除。</p>
<p><img src="/images/140937252a1e26c50d80fe821969db4056338236.jpg" alt=""></p>
<p>访问任意页面就会跳到安装页了。</p>
<p><img src="/images/14093754b38d5b50b578927334c7942f150bf3fd.jpg" alt="data"></p>
</div></article></div></section><footer><div class="paginator"><a href="/2014/10/23/yxcmssql/" class="prev">上一篇</a></div><div class="copyright"><p>© 2015 - 2016 <a href="http://xdxd.love">xd_xd</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/hkalexling/Yuno-Apollo" target="_blank">Yuno-Apollo</a>.</p></div></footer></div><script src="https://cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>