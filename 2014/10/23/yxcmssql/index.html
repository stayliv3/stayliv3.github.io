<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> yxcms一个二次注入分析 · xd_xd's blog</title><meta name="description" content="yxcms一个二次注入分析 - xd_xd"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://xdxd.love/atom.xml" title="xd_xd's blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/u/5256150165?is_all=1" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/stayliv3" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">yxcms一个二次注入分析</h1><div class="post-info">Oct 23, 2014</div><div class="post-content"><p>漏洞来源:<a href="http://huakai.paxmac.org/?p=751" target="_blank" rel="external">http://huakai.paxmac.org/?p=751</a><br>分析版本1.2.6</p>
<p>/protected/apps/member/controller/photoController.php</p>
<p>添加图集的时候，public function add() 中$data[‘sort’]=$_POST[‘sort’];post的sort变量进入数据data中，之后插入了数据库if(model(‘photo’)-&gt;insert($data))。</p>
<p>添加图集执行的sql如下：</p>
<pre><code><span class="number">2014</span>/<span class="number">10</span>/<span class="number">22</span> <span class="number">16</span>:<span class="number">08</span>    INSERT INTO yx_photo  (<span class="escape">`a</span>ccount<span class="escape">`,</span><span class="escape">`s</span>ort<span class="escape">`,</span><span class="escape">`e</span>xsort<span class="escape">`,</span><span class="escape">`t</span>itle<span class="escape">`,</span><span class="escape">`k</span>eywords<span class="escape">`,</span><span class="escape">`p</span>icture<span class="escape">`,</span><span class="escape">`d</span>escription<span class="escape">`,</span><span class="escape">`c</span>ontent<span class="escape">`,</span><span class="escape">`m</span>ethod<span class="escape">`,</span><span class="escape">`t</span>pcontent<span class="escape">`,</span><span class="escape">`i</span>spass<span class="escape">`,</span><span class="escape">`r</span>ecmd<span class="escape">`,</span><span class="escape">`h</span>its<span class="escape">`,</span><span class="escape">`n</span>order<span class="escape">`,</span><span class="escape">`a</span>ddtime<span class="escape">`,</span><span class="escape">`p</span>hotolist<span class="escape">`,</span><span class="escape">`c</span>onlist<span class="escape">`)</span> VALUES ('yx_test',',<span class="number">000000</span>,<span class="number">100002</span>\'','','<span class="number">11111111111</span>\\\'','<span class="number">11111111111</span>\\\'','﻿array(<span class="number">1</span>) {  [\<span class="string">"Filedata\"</span>]=&gt;  array(<span class="number">5</span>) {    [\<span class="string">"name\"</span>]=&gt;    string(<span class="number">12</span>) \<span class="string">"Penguins.jpg\"</span>    [\<span class="string">"type\"</span>]=&gt;    string(<span class="number">24</span>) \<span class="string">"application/octet-stream\"</span>    [\<span class="string">"tmp_name\"</span>]=&gt;    string(<span class="number">47</span>) \<span class="string">"C:\\Users\\pentest\\AppData\\Local\\Temp\\phpB93C.tmp\"</span>    [\<span class="string">"error\"</span>]=&gt;    int(<span class="number">0</span>)    [\<span class="string">"size\"</span>]=&gt;    int(<span class="number">777835</span>)  }}<span class="number">1410220407112004315418</span>.jpg ','<span class="number">11111111111</span>\\\'','<span class="number">11111111111</span>\\\'','photo/content','photo_content','<span class="number">0</span>','<span class="number">0</span>','<span class="number">0</span>','<span class="number">0</span>','<span class="number">1413965310</span>','﻿array(<span class="number">1</span>) {\r\n  [','')
</code></pre><p>这里可以看到由于yxcms一些防御策略的缺陷，进行了两次转义，插入了数据库。根据前辈的分析，验证发现sql报错。<br><img src="/images/yxcmssql11.jpg" alt="sql"></p>
<p>这里一开始不知道怎么定位分析这个问题。通过一番尝试发现整个的思路可以是这样的。分析添加图集的函数发现sort直接进入了数据库。然后搜索</p>
<pre><code>model<span class="command">\(</span><span class="command">\'</span>photo<span class="command">\'</span><span class="command">\)</span><span class="special">[</span><span class="command">\s</span><span class="command">\S</span><span class="special">]</span>+<span class="command">\[</span>'sort'<span class="command">\]</span>
</code></pre><p>根据yxcms的编码特点，一个文件中进行了photo表的数据库操作，并且该文件中含有sort字符串，匹配的结果就只有两条，基本就可以定位到这个问题了。只是一个猜测~~<br>跟进到columncontroller的content函数，跟到photocon函数里。</p>
<pre><code><span class="variable">$sortid</span>=substr(<span class="variable">$info</span>[<span class="string">'sort'</span>],-<span class="number">6</span>,<span class="number">6</span>);
        <span class="variable">$tabid</span>=model(<span class="string">'sort'</span>)-&gt;find(<span class="string">"id='{$sortid}'"</span>,<span class="string">'extendid'</span>);
</code></pre><p>substr函数反回字符串的子串：</p>
<pre><code>&lt;?php
<span class="variable">$rest</span> = substr(<span class="string">"abcdef"</span>, -<span class="number">1</span>);    // 返回 <span class="string">"f"</span>
<span class="variable">$rest</span> = substr(<span class="string">"abcdef"</span>, -<span class="number">2</span>);    // 返回 <span class="string">"ef"</span>
<span class="variable">$rest</span> = substr(<span class="string">"abcdef"</span>, -<span class="number">3</span>, <span class="number">1</span>); // 返回 <span class="string">"d"</span>
?&gt; 
</code></pre><p>所以上面这个点限制了字符串的长度，到270行看到下面的代码：</p>
<pre><code>//获取拓展数据结束
        <span class="variable">$topsort</span>=substr(<span class="variable">$info</span>[<span class="string">'sort'</span>],<span class="number">0</span>,<span class="number">14</span>); //获取顶级类
        <span class="variable">$upnews</span>=model(<span class="string">'photo'</span>)-&gt;find(<span class="string">"ispass='1'  AND id&gt;'$id' AND sort like '{$topsort}%'"</span>,<span class="string">'id,title,method'</span>,<span class="string">'id ASC'</span>,<span class="number">1</span>);//上一篇
        <span class="variable">$downnews</span>=model(<span class="string">'photo'</span>)-&gt;find(<span class="string">"ispass='1' AND id&lt;'$id' AND sort like '{$topsort}%'"</span>,<span class="string">'id,title,method'</span>,<span class="string">'id DESC'</span>,<span class="number">1</span>);//下一篇
        <span class="variable">$crumbs</span>=<span class="variable">$this-</span>&gt;crumbs(<span class="variable">$info</span>[<span class="string">'sort'</span>]);//面包屑导航
</code></pre><p>跟进crumbs函数：</p>
<pre><code>protected  <span class="keyword">function</span>  crumbs(<span class="variable">$path</span>=<span class="string">',000000'</span>)
{
    <span class="variable">$crumb</span>=array();
    if(strlen(<span class="variable">$path</span>)&gt;<span class="number">7</span>){
        <span class="variable">$ids</span>=substr(<span class="variable">$path</span>,<span class="number">8</span>);
        <span class="variable">$crumb</span>=model(<span class="string">'sort'</span>)-&gt;select(<span class="string">"id IN($ids)"</span>,<span class="string">'id,type,name,ename,method,url,extendid'</span>,<span class="string">'deep'</span>);
        foreach (<span class="variable">$crumb</span> as <span class="variable">$key</span>=&gt;<span class="variable">$vo</span>){
            <span class="variable">$crumb</span>[<span class="variable">$key</span>][<span class="string">'url'</span>]=getURl(<span class="variable">$vo</span>[<span class="string">'type'</span>],<span class="variable">$vo</span>[<span class="string">'method'</span>],<span class="variable">$vo</span>[<span class="string">'url'</span>],<span class="variable">$vo</span>[<span class="string">'id'</span>],<span class="variable">$vo</span>[<span class="string">'extendid'</span>],<span class="variable">$vo</span>[<span class="string">'ename'</span>]);
        }
    }
    return <span class="variable">$crumb</span>;
}
</code></pre><p>这里$ids也没有加单引号。</p>
<p><img src="/images/yxcmssql2.jpg" alt="sql"></p>
<p>通过黑盒的方式测试出字段3会回显，获得数据库版本的信息。</p>
<p><img src="/images/yxcmssql3.jpg" alt="sql"></p>
</div></article></div></section><footer><div class="paginator"><a href="/2014/10/27/xctf1/" class="prev">上一篇</a><a href="/2014/10/21/yxcms/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2016 <a href="http://xdxd.love">xd_xd</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>