<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 几个DOM XSS案例分析 · xd_xd's blog</title><meta name="description" content="几个DOM XSS案例分析 - xd_xd"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://xdxd.love/atom.xml" title="xd_xd's blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/u/5256150165?is_all=1" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/stayliv3" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">几个DOM XSS案例分析</h1><div class="post-info">Nov 3, 2015</div><div class="post-content"><p>案例一：</p>
<p>搜索框输入payload，点击搜索的时候触发。利用起来比较鸡肋，一直对dom xss没有仔细分析过，记录一下dom xss的常规分析方法。</p>
<p><img src="/images/domxss1.png" alt=""></p>
<p>在输入框中输入单引号，查看console报错。定位到goPage函数。<br><img src="/images/domxss2.png" alt=""></p>
<p>定位到相关代码：</p>
<pre><code><span class="function"><span class="keyword">function</span> <span class="title">getSearchKeys</span>(<span class="params"></span>) </span>{
    <span class="keyword">var</span> keys = {};
    <span class="keyword">if</span> (!<span class="built_in">window</span>.location.search)
        <span class="keyword">return</span> keys;
    <span class="keyword">for</span> (<span class="keyword">var</span> t = <span class="built_in">window</span>.location.search.slice(<span class="number">1</span>).split(<span class="string">"&amp;"</span>), i = <span class="number">0</span>, len = t.length; len &gt; i; i++) {
        <span class="keyword">var</span> m = t[i].split(<span class="string">"="</span>);
        keys[m[<span class="number">0</span>]] = m[<span class="number">1</span>]
    }
    <span class="keyword">return</span> keys
}
<span class="function"><span class="keyword">function</span> <span class="title">goPage</span>(<span class="params">keys</span>) </span>{
    <span class="built_in">window</span>.location.href = <span class="built_in">window</span>.location.protocol + <span class="string">"//"</span> + <span class="built_in">window</span>.location.host + <span class="built_in">window</span>.location.pathname + <span class="string">"?"</span> + <span class="built_in">eval</span>(<span class="string">"'"</span> + <span class="built_in">JSON</span>.stringify(keys) + <span class="string">"'"</span>).slice(<span class="number">1</span>, -<span class="number">1</span>).replace(<span class="regexp">/\"/g</span>, <span class="string">""</span>).replace(<span class="regexp">/\:/g</span>, <span class="string">"="</span>).replace(<span class="regexp">/\,/g</span>, <span class="string">"&amp;"</span>)
}
</code></pre><p>getSearchKeys获取url中的search参数，保存到keys中。在goPage中，keys进入了eval函数。如下：</p>
<pre><code>eval<span class="list">(<span class="string">"'"</span> + JSON.stringify<span class="list">(<span class="keyword">keys</span>)</span> + <span class="string">"'"</span>)</span>
</code></pre><p>导致js执行。</p>
<p><img src="/images/domxss3.png" alt=""></p>
<p>调试js，异常时断点。可以观察keys的值，以及eval执行的字符串。</p>
<p>修复代码：去掉了eval函数</p>
<pre><code><span class="function"><span class="keyword">function</span> <span class="title">goPage</span>(<span class="params">keys</span>) </span>{
        <span class="keyword">var</span> sk = combineKeys(keys);
        <span class="built_in">window</span>.location.href = <span class="built_in">window</span>.location.protocol + <span class="string">"//"</span> + <span class="built_in">window</span>.location.host + <span class="built_in">window</span>.location.pathname + <span class="string">"?"</span> + sk
    }
    <span class="function"><span class="keyword">function</span> <span class="title">combineKeys</span>(<span class="params">keys</span>) </span>{
        <span class="keyword">var</span> currSearch = <span class="built_in">window</span>.location.search;
        <span class="keyword">if</span> (currSearch) {
            currSearch = currSearch.slice(<span class="number">1</span>) + <span class="string">"&amp;"</span>;
            <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> keys)
                <span class="keyword">if</span> (currSearch.indexOf(key + <span class="string">"="</span>) &gt;= <span class="number">0</span>) {
                    <span class="keyword">var</span> reg = <span class="keyword">new</span> <span class="built_in">RegExp</span>(key + <span class="string">"=(.|\n)*?&amp;"</span>);
                    currSearch = currSearch.replace(reg, key + <span class="string">"="</span> + keys[key] + <span class="string">"&amp;"</span>)
                } <span class="keyword">else</span>
                    currSearch = currSearch + key + <span class="string">"="</span> + keys[key] + <span class="string">"&amp;"</span>;
            currSearch = currSearch.slice(<span class="number">0</span>, -<span class="number">1</span>)
        } <span class="keyword">else</span>
            <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> keys)
                currSearch = currSearch + key + <span class="string">"="</span> + keys[key];
        <span class="keyword">return</span> currSearch
    }
</code></pre><p>案例二：</p>
<p><a href="https://url?fileName=111jpg&amp;cameraName=%3C/span%3E%3Cscript%3Ealert(1)%3C/script%3E%3C/span%3E" target="_blank" rel="external">https://url?fileName=111jpg&amp;cameraName=%3C/span%3E%3Cscript%3Ealert(1)%3C/script%3E%3C/span%3E</a>  触发。</p>
<p>形式看起来像反射xss，但是搜索源码没有发现alert关键词。在script标签中，输入alert(1);111111这样执行到这里的时候会触发异常，使用chrome的调试工具的异常断点。</p>
<p><img src="/images/dom2.jpg" alt=""></p>
<p>之后使用F10 step over next function call 按钮。定位到<br><img src="/images/dom3.jpg" alt=""></p>
<p>看到是因为$(‘#cameraName’).html(cameraName); 直接html()获取到的内容导致的dom型xss。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2015/11/10/sqlmap使用tips/" class="prev">上一篇</a><a href="/2015/10/27/Java-JMX-Server-代码执行漏洞利用及防御/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2016 <a href="http://xdxd.love">xd_xd</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>