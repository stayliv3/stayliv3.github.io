<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 代码审计之命令执行 · xd_xd's blog</title><meta name="description" content="代码审计之命令执行 - xd_xd"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><script src="/js/jquery-3.1.0.min.js"></script><script src="/js/jquery.goup.js"></script><script src="/js/goup.js"></script><link rel="search" type="application/opensearchdescription+xml" href="http://xdxd.love/atom.xml" title="xd_xd's blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/logo.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="https://github.com/hkalexling" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/archives" target="_self" class="nav-list-link">ARCHIVES</a></li><li class="nav-list-item"><a href="/friends" target="_self" class="nav-list-link">FRIENDS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">代码审计之命令执行</h1><div class="post-info">Jun 9, 2015</div><div class="post-content"><p>命令执行可以细分成系统命令执行和代码注入。漏洞成因都是因为用户输入进入了关键函数导致的。</p>
<p><img src="/images/mingling1.png" alt=""></p>
<p>#代码注入</p>
<h2 id="关键函数">关键函数</h2><p>eval(), assert(), preg_replace(), call_user_func(), call_user_func_array(), array_map() 以及动态函数$a($b)，</p>
<h2 id="assert"><a href="http://php.net/manual/zh/function.assert.php" target="_blank" rel="external">assert</a></h2><pre><code>bool assert ( mixed <span class="variable">$assertion</span> [, string <span class="variable">$description</span> ] )
assert() 会检查指定的 assertion 并在结果为 FALSE 时采取适当的行动。

如果 assertion 是字符串，它将会被 assert() 当做 PHP 代码来执行。
</code></pre><p>测试代码：</p>
<pre><code><span class="php"><span class="preprocessor">&lt;?php</span>
<span class="variable">$a</span>=<span class="variable">$_GET</span>[<span class="string">'a'</span>];
<span class="comment">#fdsffd</span>
assert(<span class="variable">$a</span>);
<span class="variable">$b</span>=<span class="string">'feafdea'</span>;
<span class="comment">// var_dump(assert($a));</span>
<span class="comment">// var_dump(assert('2 &lt; 1'));</span>
<span class="preprocessor">?&gt;</span></span>
</code></pre><p>当test.php?a=phpinfo()时，phpinfo()会被执行。</p>
<h2 id="eval"><a href="http://php.net/manual/zh/function.eval.php" target="_blank" rel="external">eval</a></h2><pre><code>mixed eval ( string <span class="variable">$code</span> )
把字符串 code 作为PHP代码执行。
</code></pre><p>eval就更加直接了。</p>
<h2 id="call_user_func"><a href="http://php.net/manual/zh/function.call-user-func.php" target="_blank" rel="external">call_user_func</a></h2><p>call_user_func_array — 调用回调函数，并把一个数组参数作为回调函数的参数</p>
<p>mixed call_user_func ( callable $callback [, mixed $parameter [, mixed $… ]] )<br>第一个参数 callback 是被调用的回调函数，其余参数是回调函数的参数。</p>
<p>测试代码：</p>
<pre><code>call_user_func(<span class="variable">$_REQUEST[</span><span class="string">'func'</span>], <span class="variable">$_REQUEST[</span><span class="string">'pass'</span>])<span class="comment">;</span>
</code></pre><h2 id="preg_replace"><a href="http://php.net/manual/zh/function.preg-replace.php" target="_blank" rel="external">preg_replace</a></h2><p>preg_replace — 执行一个正则表达式的搜索和替换</p>
<p>说明 </p>
<p>mixed preg_replace ( mixed $pattern , mixed $replacement , mixed $subject [, int $limit = -1 [, int &amp;$count ]] )<br>搜索subject中匹配pattern的部分， 以replacement进行替换。</p>
<p>测试代码：</p>
<pre><code><span class="php"><span class="preprocessor">&lt;?php</span>

preg_replace(<span class="string">"/\[(.*)\]/e"</span>,<span class="string">'\\1'</span>,<span class="variable">$_GET</span>[<span class="string">'str'</span>]);

<span class="preprocessor">?&gt;</span></span>
</code></pre><p>典型案例:</p>
<h1 id="系统命令执行">系统命令执行</h1><h2 id="关键函数-1">关键函数</h2><p>system(),exec(),</p>
<h2 id="system">system</h2><p>样例代码：</p>
<pre><code>&lt;?php

// include(<span class="string">"common.php"</span>);
// showMenu();
// echo <span class="string">'&lt;br&gt;'</span>;
<span class="variable">$status</span> = $_GET[<span class="string">'status'</span>];
<span class="variable">$ns</span>  = $_GET[<span class="string">'ns'</span>];
<span class="variable">$host</span>   = $_GET[<span class="string">'host'</span>];
<span class="variable">$query</span>_type   = $_GET[<span class="string">'query_type'</span>]; // ANY, MX, A , etc.
<span class="variable">$ip</span>     = $_SERVER[<span class="string">'REMOTE_ADDR'</span>];
<span class="variable">$self</span>   = $_SERVER[<span class="string">'PHP_SELF'</span>];
    <span class="variable">$host</span> = trim(<span class="variable">$host</span>);
      <span class="variable">$host</span> = strtolower(<span class="variable">$host</span>);
      echo(<span class="string">"&lt;span class=\"</span>plainBlue\<span class="string">"&gt;&lt;b&gt;Executing : &lt;u&gt;dig @$ns $host $query_type&lt;/u&gt;&lt;/b&gt;&lt;br&gt;"</span>);
      echo <span class="string">'&lt;pre&gt;'</span>;
      //<span class="keyword">start</span> digging <span class="keyword">in</span> the namserver
      system (<span class="string">"dig @$ns $host $query_type"</span>);
      echo <span class="string">'&lt;/pre&gt;'</span>;
?&gt;
</code></pre><h2 id="利用方式：">利用方式：</h2><p>使用<code>||</code>分隔，执行多条命令</p>
</div></article></div></section><footer><div class="paginator"><a href="/2015/06/11/逻辑漏洞之找回密码/" class="prev">上一篇</a><a href="/2015/06/05/代码审计之ecshop低权限用户提权/" class="next">下一篇</a></div><div class="copyright"><p>© 2016 <a href="http://xdxd.love">xd_xd</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/hkalexling/Yuno-Apollo" target="_blank">Yuno-Apollo</a>.</p></div></footer></div><script src="https://cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>