<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> CSP案例分析 · xd_xd's blog</title><meta name="description" content="CSP案例分析 - xd_xd"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><script src="/js/jquery-3.1.0.min.js"></script><script src="/js/jquery.goup.js"></script><script src="/js/goup.js"></script><link rel="search" type="application/opensearchdescription+xml" href="http://xdxd.love/atom.xml" title="xd_xd's blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/logo.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="https://github.com/hkalexling" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/archives" target="_self" class="nav-list-link">ARCHIVES</a></li><li class="nav-list-item"><a href="/friends" target="_self" class="nav-list-link">FRIENDS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">CSP案例分析</h1><div class="post-info">Apr 10, 2015</div><div class="post-content"><p>#参考资料<br><a href="http://drops.wooyun.org/tips/1439" target="_blank" rel="external">http://drops.wooyun.org/tips/1439</a><br><a href="http://zone.wooyun.org/content/1310" target="_blank" rel="external">http://zone.wooyun.org/content/1310</a></p>
<p>#基本概念</p>
<p>内容安全策略（Content Security Policy，简称CSP）是一种以可信白名单作机制，来限制网站中是否可以包含某来源内容。默认配置下不允许执行内联代码</p>
<pre><code>(&lt;script&gt;块内容，内联事件，内联样式），以及禁止执行<span class="function"><span class="title">eval</span><span class="params">()</span></span> , <span class="function"><span class="title">newFunction</span><span class="params">()</span></span> , <span class="function"><span class="title">setTimeout</span><span class="params">([string], …)</span></span> 和<span class="function"><span class="title">setInterval</span><span class="params">([string], …)</span></span> 
</code></pre><p>#普及难度</p>
<p>参见zone里大神的讨论，</p>
<pre><code>余弦&lt;evilcos@gmail.com&gt; <span class="number">19</span>:<span class="number">38</span>:<span class="number">25</span> 
不过这个得有段时间了  也许<span class="number">2</span>年？ 

superhei&lt;<span class="number">0</span>x@<span class="number">557.</span>im&gt; <span class="number">19</span>:<span class="number">38</span>:<span class="number">39</span> 
<span class="number">20</span>年都不行 
</code></pre><p>那是12年的对话了，现在看来应该是20年都不行了。根据zoomeye14年2月份的统计国内1千万的域名（含子域名）中发现7个使用了CSP策略，其中还有3个网站CSP语法使用错误。剩下4个站点3个是知乎的。。。</p>
<p>看一下知乎的CSP策略：</p>
<pre><code><span class="attribute">Content-Security-Policy</span>: <span class="string">default-src *; frame-src *.zhihu.com getpocket.com note.youdao.com; script-src *.zhihu.com *.google-analytics.com 'unsafe-eval'; style-src *.zhihu.com 'unsafe-inline'</span>
<span class="attribute">Expires</span>: <span class="string">Fri, 02 Jan 2000 00:00:00 GMT</span>
<span class="attribute">Vary</span>: <span class="string">Accept-Encoding</span>
<span class="attribute">Pragma</span>: <span class="string">no-cache</span>
<span class="attribute">Cache-Control</span>: <span class="string">private, no-store, max-age=0, no-cache, must-revalidate, post-check=0, pre-check=0</span>
<span class="attribute">X-Frame-Options</span>: <span class="string">DENY</span>
</code></pre><p>解读一下：</p>
<p>default-src <em>;默认可以加载任意域<br>frame-src </em>.zhihu.com getpocket.com note.youdao.com; 白名单<br>script-src <em>.zhihu.com </em>.google-analytics.com ‘unsafe-eval’; 白名单，使用了unsafe-eval<br>style-src *.zhihu.com ‘unsafe-inline’ 白名单，使用了unsafe-inline</p>
<p>看到蘑菇街也加了CSP策略：</p>
<pre><code>Content-Security-Policy: script-src 'self' 'unsafe-inline' 'unsafe-eval' <span class="keyword">*</span>.mogujie.com <span class="keyword">*</span>.mogujie.com:8080 <span class="keyword">*</span>.mogujie.cn <span class="keyword">*</span>.mogucdn.com <span class="keyword">*</span>.juangua.com <span class="keyword">*</span>.mogujie.org <span class="keyword">*</span>.xiaodian.com www.google-analytics.com ssl.google-analytics.com hm.baidu.com d.emarbox.com ssl.emarbox.com bdimg.share.baidu.com; report-uri http://ss.mogujie.com/csp/index
X-Content-Security-Policy: script-src 'self' 'unsafe-inline' 'unsafe-eval' <span class="keyword">*</span>.mogujie.com <span class="keyword">*</span>.mogujie.com:8080 <span class="keyword">*</span>.mogujie.cn <span class="keyword">*</span>.mogucdn.com <span class="keyword">*</span>.juangua.com <span class="keyword">*</span>.mogujie.org <span class="keyword">*</span>.xiaodian.com www.google-analytics.com ssl.google-analytics.com hm.baidu.com d.emarbox.com ssl.emarbox.com bdimg.share.baidu.com; report-uri http://ss.mogujie.com/csp/index
X-WebKit-CSP: script-src 'self' 'unsafe-inline' 'unsafe-eval' <span class="keyword">*</span>.mogujie.com <span class="keyword">*</span>.mogujie.com:8080 <span class="keyword">*</span>.mogujie.cn <span class="keyword">*</span>.mogucdn.com <span class="keyword">*</span>.juangua.com <span class="keyword">*</span>.mogujie.org <span class="keyword">*</span>.xiaodian.com www.google-analytics.com ssl.google-analytics.com hm.baidu.com d.emarbox.com ssl.emarbox.com bdimg.share.baidu.com; report-uri http://ss.mogujie.com/csp/index
</code></pre><p>使用了Content-Security-Policy，X-Content-Security-Policy，X-WebKit-CSP 为了兼容IE浏览器，知乎没有做IE浏览器兼容,比较任性。解读一下：</p>
<p>script-src ‘self’ ‘unsafe-inline’ ‘unsafe-eval’ <em>.mogujie.com </em>.mogujie.com:8080 <em>.mogujie.cn </em>.mogucdn.com <em>.juangua.com </em>.mogujie.org *.xiaodian.com www.google-analytics.com ssl.google-analytics.com hm.baidu.com d.emarbox.com ssl.emarbox.com bdimg.share.baidu.com;</p>
<p>白名单了很多地址，但是这里使用了unsafe-inline。使用unsafe-inline，CSP的效果就大大折扣，这也是因为业务上有时候会有不少inline的脚本。可以看到知乎已经经过改造，没有使用内联的脚本了。</p>
<p>内联脚本实在是太常见了。可见CSP任重道远。</p>
<p>刚刚在zoomeye搜了一下</p>
<p><img src="/images/csp3.png" alt="2"></p>
</div></article></div></section><footer><div class="paginator"><a href="/2015/04/10/csp绕过/" class="prev">上一篇</a><a href="/2015/04/09/andbug安装/" class="next">下一篇</a></div><div class="copyright"><p>© 2016 <a href="http://xdxd.love">xd_xd</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/hkalexling/Yuno-Apollo" target="_blank">Yuno-Apollo</a>.</p></div></footer></div><script src="https://cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>