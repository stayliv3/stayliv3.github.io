<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> HTTP响应的X-头部 · xd_xd's blog</title><meta name="description" content="HTTP响应的X-头部 - xd_xd"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><script src="/js/jquery-3.1.0.min.js"></script><script src="/js/jquery.goup.js"></script><script src="/js/goup.js"></script><link rel="search" type="application/opensearchdescription+xml" href="http://xdxd.love/atom.xml" title="xd_xd's blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/logo.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="https://github.com/hkalexling" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/archives" target="_self" class="nav-list-link">ARCHIVES</a></li><li class="nav-list-item"><a href="/friends" target="_self" class="nav-list-link">FRIENDS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">HTTP响应的X-头部</h1><div class="post-info">Apr 11, 2015</div><div class="post-content"><p>读《web前段黑客技术揭秘》第十章笔记。</p>
<p>#X-Frame-Options</p>
<p>可以有两个值，deny和sameorigin</p>
<p>之前在<a href="http://stayliv3.github.io/2015/04/10/CSP%E9%81%90%E6%83%B3/" target="_blank" rel="external">CSP案例分析</a>文章里，分析知乎的响应头的时候看到有X-Frame-Options。下面看一下github的响应头。</p>
<pre><code><span class="status">HTTP/1.1 <span class="number">200</span> OK</span>
<span class="attribute">Server</span>: <span class="string">GitHub.com</span>
<span class="attribute">Date</span>: <span class="string">Sat, 11 Apr 2015 03:12:27 GMT</span>
<span class="attribute">Content-Type</span>: <span class="string">text/html; charset=utf-8</span>
<span class="attribute">Status</span>: <span class="string">200 OK</span>
<span class="attribute">Content-Security-Policy</span>: <span class="string">default-src *; script-src assets-cdn.github.com collector-cdn.github.com; object-src assets-cdn.github.com; style-src 'self' 'unsafe-inline' 'unsafe-eval' assets-cdn.github.com; img-src 'self' data: assets-cdn.github.com identicons.github.com www.google-analytics.com collector.githubapp.com *.githubusercontent.com *.gravatar.com *.wp.com; media-src 'none'; frame-src 'self' render.githubusercontent.com gist.github.com www.youtube.com player.vimeo.com checkout.paypal.com; font-src assets-cdn.github.com; connect-src 'self' live.github.com wss://live.github.com uploads.github.com status.github.com api.github.com www.google-analytics.com github-cloud.s3.amazonaws.com</span>
<span class="attribute">Cache-Control</span>: <span class="string">no-cache</span>
<span class="attribute">X-GitHub-User</span>: <span class="string">stayliv3</span>
<span class="attribute">X-GitHub-Session-Id</span>: <span class="string">50539430</span>
<span class="attribute">Vary</span>: <span class="string">X-PJAX</span>
<span class="attribute">X-UA-Compatible</span>: <span class="string">IE=Edge,chrome=1</span>
<span class="attribute">Set-Cookie</span>: <span class="string"></span>
<span class="attribute">X-Request-Id</span>: <span class="string">8fbf70a3d7</span>
<span class="attribute">X-Runtime</span>: <span class="string">0.446330</span>
<span class="attribute">X-GitHub-Request-Id</span>: <span class="string">7B9DD012:4D8B:BD4DE8:55289119</span>
<span class="attribute">Strict-Transport-Security</span>: <span class="string">max-age=31536000; includeSubdomains; preload</span>
<span class="attribute">X-Content-Type-Options</span>: <span class="string">nosniff</span>
<span class="attribute">X-XSS-Protection</span>: <span class="string">1; mode=block</span>
<span class="attribute">X-Frame-Options</span>: <span class="string">deny</span>
<span class="attribute">Vary</span>: <span class="string">Accept-Encoding</span>
<span class="attribute">X-Served-By</span>: <span class="string">bc4c952d0895</span>
<span class="attribute">Content-Length</span>: <span class="string">39232</span>
</code></pre><p>可以看到使用了非常多的X系列的header。CSP的配置也是仅仅使用了白名单，没有使用 unsafe-inline unsafe-eval。感觉浏览器作为一个平台，安全特性可能会越来越多，前端漏洞的防御策略都应该尽可能从应用的逻辑中分离出来，利用浏览器的安全特性或者X头部单独处理。比如CSRF最好的策略应该是放在头部中的token。</p>
<p>写个html包含github尝试一下：<br><img src="/images/iframe1.png" alt="iframe"><br>console中可以看到：</p>
<pre><code>Refused <span class="built_in">to</span> display <span class="string">'https://github.com/search?q=java+csrf+midware&amp;type=Code&amp;utf8=%E2%9C%93'</span> <span class="operator">in</span> <span class="operator">a</span> frame because <span class="keyword">it</span> <span class="built_in">set</span> <span class="string">'X-Frame-Options'</span> <span class="built_in">to</span> <span class="string">'deny'</span>.
</code></pre><p>#X-XSS-Protection</p>
<p>这个默认是启用的。而且利用浏览器的XSS Filter可以做一些比较有技巧的事情，比如<a href="http://stayliv3.github.io/2015/04/01/ali-ctf-xss/" target="_blank" rel="external">alictf xss</a>这里，利用xss filter干掉原本网页中的内联脚本。但是github使用了    X-XSS-Protection: 1; mode=block block模式。</p>
<p>block模式是强制不渲染，chrome下直接跳转空白页，IE下返回#符号。这样的话，就不会存在利用xss filter干掉内联脚本的事情了。这样子在设计原则上应该是最好的。</p>
<p>##检测到攻击之后应该是停止执行，退出程序，这是最安全的设计方式。而很多设计里都是检测到攻击，对攻击做一个处理，继续执行。这样就可能处理不当，没有成功防御攻击。但是浏览器默认选择了后一种，可能是为了避免误报导致的用户体验不好。仔细想了一下，浏览器这个默认策略是很合理的。毕竟每个应用的场景的不一样。浏览器是要兼容所有的web应用。如果企业认为自己的应用场景需要更强大的保护可以自己开启block模式来增强防御。</p>
<p>测试代码：</p>
<pre><code><span class="php"><span class="preprocessor">&lt;?php</span>

header(<span class="string">'X-XSS-Protection: 1'</span>);
<span class="keyword">echo</span>(<span class="string">'test'</span>);
<span class="keyword">echo</span>(<span class="variable">$_GET</span>[xss]);

<span class="preprocessor">?&gt;</span></span>
</code></pre><p>默认情况下：浏览器禁止了代码中js的执行。但是其他的输出是正常的。</p>
<pre><code>The XSS Auditor refused to<span class="instruction"> execute </span>a script in<span class="function"> 'http://127.0.0.1/test/xss.php?xss=111%3Cscript%3Ealert(</span>1<span class="function">)</span>%3C/script%3E' because its source code was found within the request. The server sent an 'X-XSS-Protection' header requesting this behavior.
</code></pre><p><img src="/images/iframe2.png" alt="iframe"></p>
<p>修改为block模式：</p>
<pre><code><span class="php"><span class="preprocessor">&lt;?php</span>

header(<span class="string">'X-XSS-Protection: 1; mode=block'</span>);
<span class="keyword">echo</span>(<span class="string">'test'</span>);
<span class="keyword">echo</span>(<span class="variable">$_GET</span>[xss]);

<span class="preprocessor">?&gt;</span></span>
</code></pre><p>浏览器不是禁止了代码的执行，而是直接屏蔽了页面的访问。</p>
<pre><code>The XSS Auditor blocked access <span class="built_in">to</span> <span class="string">'http://127.0.0.1/test/xss.php?xss=111%3Cscript%3Ealert(1)%3C/script%3E'</span> because <span class="operator">the</span> source code <span class="operator">of</span> <span class="operator">a</span> script was found <span class="operator">within</span> <span class="operator">the</span> request. The server sent <span class="operator">an</span> <span class="string">'X-XSS-Protection'</span> header requesting this behavior.
</code></pre><p><img src="/images/iframe3.png" alt="iframe"></p>
</div></article></div></section><footer><div class="paginator"><a href="/2015/04/14/访问控制/" class="prev">上一篇</a><a href="/2015/04/10/csp绕过/" class="next">下一篇</a></div><div class="copyright"><p>© 2016 <a href="http://xdxd.love">xd_xd</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/hkalexling/Yuno-Apollo" target="_blank">Yuno-Apollo</a>.</p></div></footer></div><script src="https://cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>