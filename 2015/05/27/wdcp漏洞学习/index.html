<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> wdcp漏洞学习 · xd_xd's blog</title><meta name="description" content="wdcp漏洞学习 - xd_xd"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><script src="/js/jquery-3.1.0.min.js"></script><script src="/js/jquery.goup.js"></script><script src="/js/goup.js"></script><link rel="search" type="application/opensearchdescription+xml" href="http://xdxd.love/atom.xml" title="xd_xd's blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/logo.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="https://github.com/hkalexling" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/archives" target="_self" class="nav-list-link">ARCHIVES</a></li><li class="nav-list-item"><a href="/friends" target="_self" class="nav-list-link">FRIENDS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">wdcp漏洞学习</h1><div class="post-info">May 27, 2015</div><div class="post-content"><p>#相关资料<br><a href="http://wooyun.org/bugs/wooyun-2010-05835" target="_blank" rel="external">wdcp登录认证绕过</a></p>
<p>#漏洞分析</p>
<p>伪造cookie绕过登录：影响版本2.2一下。</p>
<p>login.php 82行</p>
<pre><code><span class="keyword">if</span> (isset($_COOKIE[<span class="string">'wdcp_user'</span>]) and ($_COOKIE[<span class="string">'wdcp_user'</span>]!=<span class="string">"deleted"</span>)) {
//if (($_COOKIE[<span class="string">'wdcp_user'</span>]!=<span class="string">"deleted"</span>)) {
    <span class="variable">$wdcp</span>_user=$_COOKIE[<span class="string">'wdcp_user'</span>];
    <span class="variable">$wdcp</span>_uid=$_COOKIE[<span class="string">'wdcp_uid'</span>];
    <span class="variable">$wdcp</span>_gid=$_COOKIE[<span class="string">'wdcp_gid'</span>];
    <span class="variable">$wdcp</span>_us=$_COOKIE[<span class="string">'wdcp_us'</span>];
    <span class="variable">$wdcp</span>_lt=$_COOKIE[<span class="string">'wdcp_lt'</span>];
    //echo <span class="string">"wdcp_lt:"</span>.<span class="variable">$wdcp</span>_lt;echo <span class="string">"&lt;br&gt;"</span>;
    user_l_check(<span class="variable">$wdcp</span>_lt);
    if (<span class="variable">$wdcp</span>_gid==<span class="number">1</span>) {
        session_start();
        <span class="variable">$sessionId</span> = session_id();
        //setcookie(<span class="string">'PHPSESSID'</span>, <span class="variable">$sessionId</span>, time() + <span class="number">180</span>,<span class="string">'/'</span>);
        }
    //echo $_COOKIE[<span class="string">'wdcp_user'</span>].<span class="string">"|"</span>.$_COOKIE[<span class="string">'wdcp_uid'</span>].<span class="string">"|"</span>.$_COOKIE[<span class="string">'wdcp_gid'</span>].<span class="string">"|"</span>.$_COOKIE[<span class="string">'wdcp_us'</span>].<span class="string">"&lt;br&gt;"</span>;
    //echo <span class="variable">$wdcp</span>_user.<span class="string">"|"</span>.<span class="variable">$wdcp</span>_uid.<span class="string">"|"</span>.<span class="variable">$wdcp</span>_gid.<span class="string">"|"</span>.<span class="variable">$wdcp</span>_us;//exit;

}
</code></pre><p>跟进user_l_check函数：</p>
<pre><code><span class="keyword">function</span> user_l_check(<span class="variable">$ul</span>_str=<span class="number">0</span>) {
    global <span class="variable">$wdcp</span>_user,<span class="variable">$wdcp</span>_uid,<span class="variable">$wdcp</span>_gid,<span class="variable">$wdcp</span>_us;
    //<span class="variable">$str</span>=<span class="string">'wdl_a'</span>;
    <span class="variable">$str</span>=substr(md5(<span class="variable">$wdcp</span>_user.<span class="variable">$wdcp</span>_uid),<span class="number">8</span>,<span class="number">6</span>);
    //echo <span class="variable">$str</span>.<span class="string">"&lt;br&gt;"</span>;
    if (<span class="variable">$ul</span>_str==<span class="number">0</span>) {
        //echo <span class="variable">$str</span>;
        //echo <span class="variable">$str</span>.<span class="string">"&lt;br&gt;"</span>;
        //<span class="variable">$msg</span>=<span class="variable">$str</span>.<span class="string">"|"</span>.<span class="variable">$wdcp</span>_user.<span class="string">"|"</span>.<span class="variable">$wdcp</span>_uid.<span class="string">"|"</span>.<span class="variable">$wdcp</span>_gid.<span class="string">"|"</span>.<span class="variable">$wdcp</span>_us;
        //file_put_contents(WD_ROOT.<span class="string">"/data/1.txt"</span>,<span class="variable">$msg</span>);
        return md5(<span class="variable">$str</span>.<span class="variable">$wdcp</span>_user.<span class="variable">$wdcp</span>_uid.<span class="variable">$wdcp</span>_gid.<span class="variable">$wdcp</span>_us);
    }else {
        //echo ;
        //echo <span class="variable">$str</span>.<span class="string">"&lt;br&gt;"</span>;
        //echo <span class="variable">$str</span>.<span class="string">"|"</span>.<span class="variable">$wdcp</span>_user.<span class="string">"|"</span>.<span class="variable">$wdcp</span>_uid.<span class="string">"|"</span>.<span class="variable">$wdcp</span>_gid.<span class="string">"|"</span>.<span class="variable">$wdcp</span>_us.<span class="string">"   2&lt;br&gt;"</span>;
        //<span class="variable">$msg</span>=<span class="variable">$str</span>.<span class="string">"|"</span>.<span class="variable">$wdcp</span>_user.<span class="string">"|"</span>.<span class="variable">$wdcp</span>_uid.<span class="string">"|"</span>.<span class="variable">$wdcp</span>_gid.<span class="string">"|"</span>.<span class="variable">$wdcp</span>_us;
        //file_put_contents(WD_ROOT.<span class="string">"/data/2.txt"</span>,<span class="variable">$msg</span>);
        <span class="variable">$s1</span>=md5(<span class="variable">$str</span>.<span class="variable">$wdcp</span>_user.<span class="variable">$wdcp</span>_uid.<span class="variable">$wdcp</span>_gid.<span class="variable">$wdcp</span>_us);
        //echo <span class="string">"1:"</span>.<span class="variable">$ul</span>_str.<span class="string">"|"</span>.<span class="variable">$s1</span>.<span class="string">"&lt;br&gt;"</span>;//exit;
        //file_put_contents(WD_ROOT.<span class="string">"/data/3.txt"</span>,<span class="variable">$ul</span>_str);
        //file_put_contents(WD_ROOT.<span class="string">"/data/4.txt"</span>,<span class="variable">$s1</span>);
        if (strcmp(<span class="variable">$ul</span>_str,<span class="variable">$s1</span>)!=<span class="number">0</span>) {
            del_cookie();
            //echo <span class="string">"login err"</span>;
            str_go_url(<span class="string">"登录信息错误！"</span>,<span class="number">1</span>);
            //go_back(<span class="string">"登录信息错误!"</span>);
        }
    }
</code></pre><p>函数中用来做比较的信息也都是来自cookie。所以可以伪造cookie。直接登录。</p>
<p>修复后的代码：</p>
<pre><code><span class="keyword">if</span> (isset($_SESSION[<span class="string">'is_l'</span>])) {
    <span class="variable">$wdcp</span>_user=$_COOKIE[<span class="string">'wdcp_user'</span>];
    <span class="variable">$wdcp</span>_uid=$_COOKIE[<span class="string">'wdcp_uid'</span>];
    <span class="variable">$wdcp</span>_gid=$_COOKIE[<span class="string">'wdcp_gid'</span>];
    <span class="variable">$wdcp</span>_ggid=$_COOKIE[<span class="string">'wdcp_ggid'</span>];
    <span class="variable">$wdcp</span>_us=$_COOKIE[<span class="string">'wdcp_us'</span>];
    //<span class="variable">$wdcp</span>_lt=$_COOKIE[<span class="string">'wdcp_lt'</span>];
    //session_start();
    //print_r($_SESSION);
    <span class="variable">$wdcp</span>_lt=$_SESSION[<span class="string">'is_l'</span>];
</code></pre><p>将用于检查的$wdcp_lt字段存在session里放在服务端。并判断服务端是否存在该字段，存在才进入检查逻辑。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2015/05/29/thinkphp-SQL注入风险分析/" class="prev">上一篇</a><a href="/2015/05/25/腾达路由器登录绕过漏洞/" class="next">下一篇</a></div><div class="copyright"><p>© 2016 <a href="http://xdxd.love">xd_xd</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/hkalexling/Yuno-Apollo" target="_blank">Yuno-Apollo</a>.</p></div></footer></div><script src="https://cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>