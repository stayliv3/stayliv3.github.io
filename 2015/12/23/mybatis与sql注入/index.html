<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> mybatis与sql注入 · xd_xd's blog</title><meta name="description" content="mybatis与sql注入 - xd_xd"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><script src="/js/jquery-3.1.0.min.js"></script><script src="/js/jquery.goup.js"></script><script src="/js/goup.js"></script><link rel="search" type="application/opensearchdescription+xml" href="http://xdxd.love/atom.xml" title="xd_xd's blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/logo.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="https://github.com/hkalexling" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/archives" target="_self" class="nav-list-link">ARCHIVES</a></li><li class="nav-list-item"><a href="/friends" target="_self" class="nav-list-link">FRIENDS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">mybatis与sql注入</h1><div class="post-info">Dec 23, 2015</div><div class="post-content"><p>MyBatis 是支持定制化 SQL、存储过程以及高级映射的优秀的持久层框架。MyBatis 避免了几乎所有的 JDBC 代码和手动设置参数以及获取结果集。MyBatis 可以对配置和原生Map使用简单的 XML 或注解，将接口和 Java 的 POJOs(Plain Old Java Objects,普通的 Java对象)映射成数据库中的记录。通常来说ORM的框架应该是可以避免SQL注入的，但是如果mybatis使用不当也会造成sql注入。</p>
<p>The MyBatis data mapper framework makes it easier to use a relational database with object-oriented applications. Unlike traditional ORM solutions, MyBatis maps objects with SQL statements or stored procedures using a XML descriptor, rather than mapping objects to tables in a database; thus providing complete control over SQL, therefore susceptible to SQL injection if used incorrectly.</p>
<p>MyBatis has 2 substitution methods. The <code>${}</code> method does direct string replacement (i.e. property substitution) so it’s vulnerable to SQL injection. The <code>#{}</code> method does parameter substitution on a PreparedStatement so it is not vulnerable.</p>
<pre><code>&lt;<span class="keyword">select</span> id=<span class="string">"getPerson"</span> parameterType=<span class="string">"int"</span> resultType=<span class="string">"org.application.vo.Person"</span>&gt;
<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> PERSON <span class="keyword">WHERE</span> ID = <span class="preprocessor">#{id}</span>
&lt;/<span class="keyword">select</span>&gt;
</code></pre><p>使用<code>#</code>标记参数，mybatis会使用预编译的方式来处理参数，这样子是安全的。相当于使用了如下的jdbc代码：</p>
<figure class="highlight"><figcaption><span>Comparable JDBC code */</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String selectPerson = &#34;SELECT * FROM PERSON WHERE ID = ?&#34;; &#10;PreparedStatement ps = conn.prepareStatement(selectPerson); &#10;ps.setInt(1, id);</span><br></pre></td></tr></table></figure>
<pre><code>&lt;<span class="keyword">select</span> id=<span class="string">"getPerson"</span> parameterType=<span class="string">"string"</span> resultType=<span class="string">"org.application.vo.Person"</span>&gt;
<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> PERSON <span class="keyword">WHERE</span> NAME = <span class="preprocessor">#{name} AND PHONE LIKE '${phone}'; </span>
&lt;/<span class="keyword">select</span>&gt;   
</code></pre><p>Note the parameter notation, ${phone} in the above getPerson statement. By default, using the ${} syntax will cause MyBatis to directly inject a string, unmodified, into a SQL Statement. MyBatis does NOT modify or escape the string before substitution.</p>
<p>使用<code>$</code>符号mybatis会直接将字符串注入到sql语句中，不进行任何修改和转移如果没有对phone变量进行验证的话就可能导致sql注入。</p>
<p>#安全开发建议</p>
<p>尽量使用<code>#</code>符号，如果需要要对用户提交参数进行验证。</p>
<p>like的写法：</p>
<p>mysql：</p>
<pre><code><span class="operator"><span class="keyword">select</span> * <span class="keyword">from</span> t_user <span class="keyword">where</span> <span class="keyword">name</span> <span class="keyword">like</span> <span class="keyword">concat</span>(<span class="string">'%'</span>, #{<span class="keyword">name</span>}, <span class="string">'%'</span>)  </span>
</code></pre><p>oracle：</p>
<pre><code><span class="operator"><span class="keyword">select</span> * <span class="keyword">from</span> t_user <span class="keyword">where</span> <span class="keyword">name</span> <span class="keyword">like</span> <span class="string">'%'</span> || #{<span class="keyword">name</span>} || <span class="string">'%'</span></span>
</code></pre><p>sqlserver:</p>
<pre><code><span class="operator"><span class="keyword">select</span> * <span class="keyword">from</span> t_user <span class="keyword">where</span> <span class="keyword">name</span> <span class="keyword">like</span> <span class="string">'%'</span> + #{<span class="keyword">name</span>} + <span class="string">'%'</span></span>
</code></pre><p>参考资料：</p>
<p><a href="http://apollo89.com/wordpress/?p=2175" target="_blank" rel="external">http://apollo89.com/wordpress/?p=2175</a><br><a href="http://mybatis.org/mybatis-3/zh/" target="_blank" rel="external">http://mybatis.org/mybatis-3/zh/</a><br><a href="http://software-security.sans.org/developer-how-to/fix-sql-injection-in-java-mybatis" target="_blank" rel="external">http://software-security.sans.org/developer-how-to/fix-sql-injection-in-java-mybatis</a></p>
</div></article></div></section><footer><div class="paginator"><a href="/2015/12/24/多步csrf漏洞场景及其利用/" class="prev">上一篇</a><a href="/2015/12/23/docker-cheat-sheet/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2016 <a href="http://xdxd.love">xd_xd</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/hkalexling/Yuno-Apollo" target="_blank">Yuno-Apollo</a>.</p></div></footer></div><script src="https://cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>