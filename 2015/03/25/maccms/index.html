<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> maccms urldecode导致的注入 · xd_xd's blog</title><meta name="description" content="maccms urldecode导致的注入 - xd_xd"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><script src="/js/jquery-3.1.0.min.js"></script><script src="/js/jquery.goup.js"></script><script src="/js/goup.js"></script><link rel="search" type="application/opensearchdescription+xml" href="http://xdxd.love/atom.xml" title="xd_xd's blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/logo.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="https://github.com/hkalexling" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/archives" target="_self" class="nav-list-link">ARCHIVES</a></li><li class="nav-list-item"><a href="/friends" target="_self" class="nav-list-link">FRIENDS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">maccms urldecode导致的注入</h1><div class="post-info">Mar 25, 2015</div><div class="post-content"><p>分析maccms的历史漏洞，发现在大量白帽子的洗礼下，安全性的提升还是很快的。尤其是引入360_safe3.</p>
<p><img src="/images/maccms1.png" alt="1"></p>
<p>php导致漏洞的利用成本增加。记录一下分析相关代码的过程。。在最新版中这些漏洞都已经修复了。而且最新版的360也开始检测urldecode之前的变量是否存在危险字符了。</p>
<pre><code><span class="keyword">function</span> StopAttack(<span class="variable">$StrFiltKey</span>,<span class="variable">$StrFiltValue</span>,<span class="variable">$ArrFiltReq</span>)
{
    <span class="variable">$errmsg</span> = <span class="string">"&lt;div style=\"</span>position:fixed;top:0px;width:<span class="number">100</span>%;height:<span class="number">100</span>%;background-color:white;color:green;font-weight:bold;border-bottom:<span class="number">5</span>px solid #<span class="number">999</span>;\<span class="string">"&gt;&lt;br&gt;您的提交带有不合法参数,谢谢合作!&lt;br&gt;操作IP: "</span>.$_SERVER[<span class="string">"REMOTE_ADDR"</span>].<span class="string">"&lt;br&gt;操作时间: "</span>.strftime(<span class="string">"%Y-%m-%d %H:%M:%S"</span>).<span class="string">"&lt;br&gt;操作页面:"</span>.$_SERVER[<span class="string">"PHP_SELF"</span>].<span class="string">"&lt;br&gt;提交方式: "</span>.$_SERVER[<span class="string">"REQUEST_METHOD"</span>].<span class="string">"&lt;/div&gt;"</span>;
    <span class="variable">$StrFiltValue</span>=arr_foreach(<span class="variable">$StrFiltValue</span>);
    <span class="variable">$StrFiltValue</span>=urldecode(<span class="variable">$StrFiltValue</span>);
</code></pre><p>由于%a0导致的绕过，360已经开始检测 </p>
<pre><code><span class="function"><span class="title">UNION</span><span class="params">([\s\S]*?)</span><span class="title">SELECT</span></span>
</code></pre><p>只要出现unionselect就会拦截。导致绕过难度加大。</p>
<p><a href="http://www.wooyun.org/bugs/wooyun-2014-066661" target="_blank" rel="external">http://www.wooyun.org/bugs/wooyun-2014-066661</a></p>
<p>maccms入口文件 index.php前面就有个很显眼的urldecode.</p>
<pre><code><span class="keyword">if</span>(!file_exists(<span class="string">'inc/install.lock'</span>)) { echo <span class="string">'&lt;script&gt;location.href=\'</span>install.php\<span class="string">';&lt;/script&gt;'</span>;exit; }
    define(<span class="string">'MAC_MODULE'</span>,<span class="string">'home'</span>);
    require(<span class="string">"inc/conn.php"</span>);
    require(MAC_ROOT.<span class="string">'/inc/common/360_safe3.php'</span>);
    <span class="variable">$m</span> = be(<span class="string">'get'</span>,<span class="string">'m'</span>);
    <span class="keyword">if</span>(strpos(<span class="variable">$m</span>,<span class="string">'.'</span>)){ <span class="variable">$m</span> = substr(<span class="variable">$m</span>,<span class="number">0</span>,strpos(<span class="variable">$m</span>,<span class="string">'.'</span>)); }
    <span class="variable">$par</span> = explode(<span class="string">'-'</span>,<span class="variable">$m</span>);
    <span class="variable">$parlen</span> = count(<span class="variable">$par</span>);
    <span class="variable">$ac</span> = <span class="variable">$par</span>[<span class="number">0</span>];

    <span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$ac</span>)){ <span class="variable">$ac</span>=<span class="string">'vod'</span>; <span class="variable">$method</span>=<span class="string">'index'</span>; }

    <span class="variable">$colnum</span> = <span class="keyword">array</span>(<span class="string">"id"</span>,<span class="string">"pg"</span>,<span class="string">"year"</span>,<span class="string">"typeid"</span>,<span class="string">"class"</span>,<span class="string">"classid"</span>);
    <span class="keyword">if</span>(<span class="variable">$parlen</span>&gt;=<span class="number">2</span>){
        <span class="variable">$method</span> = <span class="variable">$par</span>[<span class="number">1</span>];
         for(<span class="variable">$i</span>=<span class="number">2</span>;<span class="variable">$i</span>&lt;<span class="variable">$parlen</span>;<span class="variable">$i</span>+=<span class="number">2</span>){
            <span class="variable">$tpl-</span>&gt;P[<span class="variable">$par</span>[<span class="variable">$i</span>]] = in_array(<span class="variable">$par</span>[<span class="variable">$i</span>],<span class="variable">$colnum</span>) ? intval(<span class="variable">$par</span>[<span class="variable">$i</span>+<span class="number">1</span>]) : urldecode(<span class="variable">$par</span>[<span class="variable">$i</span>+<span class="number">1</span>]);
            echo <span class="variable">$tpl-</span>&gt;P[<span class="variable">$par</span>[<span class="variable">$i</span>]];
        }
    }
</code></pre><p>在做了全局addslash的防御策略的cms中编解码是绕过addslash的一种常见的途径。</p>
<p><img src="/images/maccms2.png" alt="1"></p>
<p>这个案例还是很经典的。跟踪be函数可以看到，通过be函数获取输入。只是对GET和POST做了addslash.</p>
<pre><code><span class="keyword">function</span> be(<span class="variable">$mode</span>,<span class="variable">$key</span>,<span class="variable">$sp</span>=<span class="string">','</span>)
{
    ini_set(<span class="string">"magic_quotes_runtime"</span>, <span class="number">0</span>);
    <span class="variable">$magicq</span>= get_magic_quotes_gpc();
    switch(<span class="variable">$mode</span>)
    {
        case <span class="string">'post'</span>:
            <span class="variable">$res</span>=isset($_POST[<span class="variable">$key</span>]) ? <span class="variable">$magicq</span>?$_POST[<span class="variable">$key</span>]:@addslashes($_POST[<span class="variable">$key</span>]) : <span class="string">''</span>;
            break;
        case <span class="string">'get'</span>:
            <span class="variable">$res</span>=isset($_GET[<span class="variable">$key</span>]) ? <span class="variable">$magicq</span>?$_GET[<span class="variable">$key</span>]:@addslashes($_GET[<span class="variable">$key</span>]) : <span class="string">''</span>;
            break;
        case <span class="string">'arr'</span>:
            <span class="variable">$arr</span> =isset($_POST[<span class="variable">$key</span>]) ? $_POST[<span class="variable">$key</span>] : <span class="string">''</span>;
            if(<span class="variable">$arr</span>==<span class="string">""</span>){
                <span class="variable">$value</span>=<span class="string">"0"</span>;
            }
            else{
                for(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;count(<span class="variable">$arr</span>);<span class="variable">$i</span>++){
                    <span class="variable">$res</span>=implode(<span class="variable">$sp</span>,<span class="variable">$arr</span>);
                } 
            }
            break;
        default:
            <span class="variable">$res</span>=isset($_REQUEST[<span class="variable">$key</span>]) ? <span class="variable">$magicq</span> ? $_REQUEST[<span class="variable">$key</span>] : @addslashes($_REQUEST[<span class="variable">$key</span>]) : <span class="string">''</span>;
            break;
    }
    return <span class="variable">$res</span>;
}
</code></pre><p>所以对从cookie获取输入，以及使用be(‘arr’)方式获取输入都是没有过滤的点。</p>
<p>修复方案采用的是对url解码之后做了一次转义，当时这不是一个最完美的安全编码方式，虽然他解决了这个url解码导致的绕过。</p>
<pre><code>foreach(<span class="variable">$tpl-</span>&gt;P <span class="keyword">as</span> <span class="variable">$k</span>=&gt;<span class="variable">$v</span>){
    if(!is_numeric(<span class="variable">$v</span>)){
        <span class="variable">$tpl-</span>&gt;P[<span class="variable">$k</span>] = mysql_real_escape_string(<span class="variable">$v</span>);
    }
}
</code></pre></div></article></div></section><footer><div class="paginator"><a href="/2015/03/30/Bar-Mitzvah-Attack/" class="prev">上一篇</a><a href="/2015/03/24/xionghaicms/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2016 <a href="http://xdxd.love">xd_xd</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/hkalexling/Yuno-Apollo" target="_blank">Yuno-Apollo</a>.</p></div></footer></div><script src="https://cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>