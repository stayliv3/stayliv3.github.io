<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> w3school上示例代码的安全漏洞 · xd_xd's blog</title><meta name="description" content="w3school上示例代码的安全漏洞 - xd_xd"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><script src="/js/jquery-3.1.0.min.js"></script><script src="/js/jquery.goup.js"></script><script src="/js/goup.js"></script><link rel="search" type="application/opensearchdescription+xml" href="http://xdxd.love/atom.xml" title="xd_xd's blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/logo.jpg"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/about" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="https://github.com/hkalexling" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/archives" target="_self" class="nav-list-link">ARCHIVES</a></li><li class="nav-list-item"><a href="/friends" target="_self" class="nav-list-link">FRIENDS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">w3school上示例代码的安全漏洞</h1><div class="post-info">Sep 14, 2016</div><div class="post-content"><p>这个漏洞原理本身比较简单，而且很古老了。这里主要想说明一下，在w3school这样的平台上还存在着这样的代码说明我们对编写安全的代码还是不够重视。w3school上的示例对于初学者简单明了。很多人应该都看这个网站学习过web相关的知识。</p>
<p>我们用Google搜索<code>php 文件上传</code>或者英文的<code>php file upload</code> </p>
<p><img src="/images/phpupload2.png" alt=""><br><img src="/images/phpupload1.png" alt=""></p>
<p>第一个结果就是w3school的教学页面，而这个教程中给出的示例代码是存在安全漏洞的。</p>
<p>完整的代码如下：<a href="http://www.w3school.com.cn/php/php_file_upload.asp" target="_blank" rel="external">参考地址</a></p>
<p>上传的表单：</p>
<pre><code><span class="tag">&lt;<span class="title">html</span>&gt;</span>
<span class="tag">&lt;<span class="title">body</span>&gt;</span>
<span class="tag">&lt;<span class="title">form</span> <span class="attribute">action</span>=<span class="value">"upload_file.php"</span> <span class="attribute">method</span>=<span class="value">"post"</span>
<span class="attribute">enctype</span>=<span class="value">"multipart/form-data"</span>&gt;</span>
<span class="tag">&lt;<span class="title">label</span> <span class="attribute">for</span>=<span class="value">"file"</span>&gt;</span>Filename:<span class="tag">&lt;/<span class="title">label</span>&gt;</span>
<span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"file"</span> <span class="attribute">name</span>=<span class="value">"file"</span> <span class="attribute">id</span>=<span class="value">"file"</span> /&gt;</span> 
<span class="tag">&lt;<span class="title">br</span> /&gt;</span>
<span class="tag">&lt;<span class="title">input</span> <span class="attribute">type</span>=<span class="value">"submit"</span> <span class="attribute">name</span>=<span class="value">"submit"</span> <span class="attribute">value</span>=<span class="value">"Submit"</span> /&gt;</span>
<span class="tag">&lt;/<span class="title">form</span>&gt;</span>
<span class="tag">&lt;/<span class="title">body</span>&gt;</span>
<span class="tag">&lt;/<span class="title">html</span>&gt;</span>
</code></pre><p>处理的php脚本：</p>
<pre><code><span class="php"><span class="preprocessor">&lt;?php</span>
<span class="keyword">if</span> (((<span class="variable">$_FILES</span>[<span class="string">"file"</span>][<span class="string">"type"</span>] == <span class="string">"image/gif"</span>)
|| (<span class="variable">$_FILES</span>[<span class="string">"file"</span>][<span class="string">"type"</span>] == <span class="string">"image/jpeg"</span>)
|| (<span class="variable">$_FILES</span>[<span class="string">"file"</span>][<span class="string">"type"</span>] == <span class="string">"image/pjpeg"</span>))
&amp;&amp; (<span class="variable">$_FILES</span>[<span class="string">"file"</span>][<span class="string">"size"</span>] &lt; <span class="number">20000</span>))
  {
  <span class="keyword">if</span> (<span class="variable">$_FILES</span>[<span class="string">"file"</span>][<span class="string">"error"</span>] &gt; <span class="number">0</span>)
    {
    <span class="keyword">echo</span> <span class="string">"Return Code: "</span> . <span class="variable">$_FILES</span>[<span class="string">"file"</span>][<span class="string">"error"</span>] . <span class="string">"&lt;br /&gt;"</span>;
    }
  <span class="keyword">else</span>
    {
    <span class="keyword">echo</span> <span class="string">"Upload: "</span> . <span class="variable">$_FILES</span>[<span class="string">"file"</span>][<span class="string">"name"</span>] . <span class="string">"&lt;br /&gt;"</span>;
    <span class="keyword">echo</span> <span class="string">"Type: "</span> . <span class="variable">$_FILES</span>[<span class="string">"file"</span>][<span class="string">"type"</span>] . <span class="string">"&lt;br /&gt;"</span>;
    <span class="keyword">echo</span> <span class="string">"Size: "</span> . (<span class="variable">$_FILES</span>[<span class="string">"file"</span>][<span class="string">"size"</span>] / <span class="number">1024</span>) . <span class="string">" Kb&lt;br /&gt;"</span>;
    <span class="keyword">echo</span> <span class="string">"Temp file: "</span> . <span class="variable">$_FILES</span>[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>] . <span class="string">"&lt;br /&gt;"</span>;
    <span class="keyword">if</span> (file_exists(<span class="string">"upload/"</span> . <span class="variable">$_FILES</span>[<span class="string">"file"</span>][<span class="string">"name"</span>]))
      {
      <span class="keyword">echo</span> <span class="variable">$_FILES</span>[<span class="string">"file"</span>][<span class="string">"name"</span>] . <span class="string">" already exists. "</span>;
      }
    <span class="keyword">else</span>
      {
      move_uploaded_file(<span class="variable">$_FILES</span>[<span class="string">"file"</span>][<span class="string">"tmp_name"</span>],
      <span class="string">"upload/"</span> . <span class="variable">$_FILES</span>[<span class="string">"file"</span>][<span class="string">"name"</span>]);
      <span class="keyword">echo</span> <span class="string">"Stored in: "</span> . <span class="string">"upload/"</span> . <span class="variable">$_FILES</span>[<span class="string">"file"</span>][<span class="string">"name"</span>];
      }
    }
  }
<span class="keyword">else</span>
  {
  <span class="keyword">echo</span> <span class="string">"Invalid file"</span>;
  }
<span class="preprocessor">?&gt;</span></span>
</code></pre><p>文中也多次提到了文件上传的安全问题。<br><img src="/images/phpupload4.png" alt=""><br><img src="/images/phpupload5.png" alt=""></p>
<p>而为了安全，最后示例的代码中加了限制，只允许用户上传gif，jpg格式的图片。而这个限制，是通过<code>$_FILES[&quot;file&quot;][&quot;type&quot;]</code>来限制的。做安全的同学都知道，这个参数是浏览器生成传递给服务端的，虽然不是用户输入数据，但是是属于客户端传递过来的数据，也就是用户其实是可以控制这个参数的。只需要修改<code>Content-Type: image/jpeg</code> 就可以绕过这个检查，上传任意类型的文件。</p>
<p><img src="/images/phpupload6.png" alt=""></p>
<p>所以，当我们用Google搜索php文件上传，给出的第一个示例代码是存在安全漏洞的。编写安全的代码，任重而道远。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/09/18/mips架构缓冲区溢出学习二/" class="prev">上一篇</a><a href="/2016/09/08/一个blind-XXE漏洞利用分析/" class="next">下一篇</a></div><div class="copyright"><p>© 2016 <a href="http://xdxd.love">xd_xd</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/hkalexling/Yuno-Apollo" target="_blank">Yuno-Apollo</a>.</p></div></footer></div><script src="https://cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>